<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thermal Recon: Urban Sector</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; touch-action: none; }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Share Tech Mono', monospace; cursor: none; }
        canvas { display: block; }

        #ui-layer {
            position: absolute;
            top: 20px; left: 20px;
            color: #4ade80;
            pointer-events: none;
            z-index: 100;
        }

        #custom-alert {
            position: absolute;
            top: 40%; left: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid #ff4500;
            background: rgba(0, 0, 0, 0.9);
            color: #ff4500;
            padding: 20px;
            text-align: center;
            display: none;
            z-index: 200;
            letter-spacing: 2px;
            box-shadow: 0 0 20px rgba(255, 69, 0, 0.4);
        }

        #recoil-warning {
            position: absolute;
            bottom: 100px; left: 50%;
            transform: translateX(-50%);
            color: #ffcc00;
            font-size: 14px;
            display: none;
        }

        #health-container {
            position: absolute;
            bottom: 30px; left: 50%;
            transform: translateX(-50%);
            width: 300px; height: 8px;
            border: 1px solid #4ade80;
        }
        #health-bar { width: 100%; height: 100%; background: #4ade80; transition: width 0.1s; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div style="color:#ff4500">>> SIGNAL: THERMAL_ENGAGED</div>
        <div>CONFIRMED_KILLS: <span id="score">0</span></div>
        <div id="status-readout">STATUS: SCANNING...</div>
    </div>

    <div id="custom-alert">
        <h1 id="alert-title">MISSION FAILED</h1>
        <p id="alert-msg">OPERATOR ELIMINATED</p>
        <button onclick="location.reload()" style="background:#ff4500; border:none; color:black; padding:10px 20px; font-family:inherit; cursor:pointer;">RE-DEPLOY</button>
    </div>

    <div id="recoil-warning">RE-CHAMBERING ROUND...</div>

    <div id="health-container"><div id="health-bar"></div></div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        let cw, ch, score = 0, enemy = null, windows = [];
        let mouse = { x: 0, y: 0 }, recoilY = 0;
        let health = 100, isDead = false, canFire = true;
        let breathing = 0, damageFlash = 0;

        function resize() {
            cw = canvas.width = window.innerWidth;
            ch = canvas.height = window.innerHeight;
            generateBuilding();
            spawnEnemy();
        }

        function generateBuilding() {
            windows = [];
            const rows = 3, cols = 5;
            const winW = 60, winH = 80;
            const startX = cw/2 - 250, startY = ch/2 - 250;

            for(let r=0; r<rows; r++) {
                for(let c=0; c<cols; c++) {
                    windows.push({
                        x: startX + c * 100,
                        y: startY + r * 120,
                        w: winW, h: winH
                    });
                }
            }
        }

        function spawnEnemy() {
            const win = windows[Math.floor(Math.random() * windows.length)];
            enemy = {
                x: win.x + win.w/2,
                y: win.y + win.h - 10,
                timer: 0,
                lastShot: 0
            };
        }

        function playSound(pitch, vol, dur) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(pitch, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + dur);
        }

        window.addEventListener('mousemove', e => {
            mouse.x = e.clientX;
            mouse.y = e.clientY;
        });

        function drawSoldier(x, y) {
            ctx.save();
            ctx.translate(x, y);
            ctx.shadowBlur = 15; ctx.shadowColor = "#ff4500";
            ctx.fillStyle = "#ff6a00";
            ctx.beginPath(); ctx.ellipse(0, -45, 10, 8, 0, 0, Math.PI*2); ctx.fill(); // Head
            ctx.fillRect(-12, -37, 24, 35); // Body
            ctx.fillStyle = "#ffcc00";
            ctx.fillRect(5, -20, 30, 4); // Gun
            ctx.restore();
        }

        function loop() {
            if (isDead) return;

            // 1. Scene Background
            ctx.fillStyle = '#050a05';
            ctx.fillRect(0, 0, cw, ch);

            // Scope movement logic
            breathing += 0.02;
            recoilY *= 0.9; // Recover from recoil
            let sx = mouse.x + Math.sin(breathing) * 8;
            let sy = (mouse.y - recoilY) + Math.cos(breathing * 0.5) * 6;

            // 2. Thermal Vision Clip
            ctx.save();
            ctx.beginPath(); ctx.arc(sx, sy, 180, 0, Math.PI*2); ctx.clip();
            
            ctx.fillStyle = '#000022';
            ctx.fillRect(0, 0, cw, ch);

            // Draw Building Silhouette
            ctx.fillStyle = '#0a0a33';
            ctx.fillRect(cw/2 - 300, ch/2 - 300, 600, 400);
            
            // Draw Windows
            windows.forEach(w => {
                ctx.fillStyle = '#000011';
                ctx.fillRect(w.x, w.y, w.w, w.h);
                ctx.strokeStyle = '#1e3a8a';
                ctx.strokeRect(w.x, w.y, w.w, w.h);
            });

            drawSoldier(enemy.x, enemy.y);

            // Crosshair
            ctx.strokeStyle = 'rgba(255,255,255,0.3)';
            ctx.beginPath();
            ctx.moveTo(sx-180, sy); ctx.lineTo(sx+180, sy);
            ctx.moveTo(sx, sy-180); ctx.lineTo(sx, sy+180);
            ctx.stroke();
            ctx.restore();

            // Scope Ring
            ctx.strokeStyle = '#111'; ctx.lineWidth = 20;
            ctx.beginPath(); ctx.arc(sx, sy, 190, 0, Math.PI*2); ctx.stroke();

            // 3. Enemy Combat Logic
            enemy.timer += 0.016;
            if (enemy.timer > 2.5) { // Enemy takes 2.5s to aim
                if (Date.now() - enemy.lastShot > 1500) {
                    health -= 25;
                    damageFlash = 0.6;
                    playSound(80, 0.2, 0.4);
                    enemy.lastShot = Date.now();
                    document.getElementById('health-bar').style.width = health + "%";
                }
            }

            if (damageFlash > 0) {
                ctx.fillStyle = `rgba(255,0,0,${damageFlash})`;
                ctx.fillRect(0, 0, cw, ch);
                damageFlash -= 0.03;
            }

            if (health <= 0) {
                isDead = true;
                document.getElementById('custom-alert').style.display = 'block';
            }

            requestAnimationFrame(loop);
        }

        window.addEventListener('mousedown', () => {
            if (!canFire || isDead) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            // Fire Logic
            playSound(300, 0.5, 0.5);
            recoilY = 150; // Huge kick up
            canFire = false;
            document.getElementById('recoil-warning').style.display = 'block';

            // Hit Detection
            let sx = mouse.x + Math.sin(breathing) * 8;
            let sy = (mouse.y) + Math.cos(breathing * 0.5) * 6;
            let d = Math.hypot(enemy.x - sx, (enemy.y - 30) - sy);

            if (d < 35) {
                score++;
                document.getElementById('score').innerText = score;
                spawnEnemy();
            }

            // Recoil Recovery Timer
            setTimeout(() => {
                canFire = true;
                document.getElementById('recoil-warning').style.display = 'none';
            }, 1200);
        });

        window.addEventListener('resize', resize);
        resize();
        loop();
    </script>
</body>
</html>
