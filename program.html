<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CETA Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">

  <div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6">CETA Admin Dashboard</h1>

    <!-- Tabs -->
    <div class="mb-6">
      <nav class="flex space-x-4 border-b">
        <button id="tab-learners-btn" class="pb-2 border-b-4 border-blue-600 font-semibold text-blue-600">Learners</button>
        <button id="tab-courses-btn" class="pb-2 border-b-4 border-transparent hover:border-blue-600 font-semibold">Courses</button>
      </nav>
    </div>

    <!-- Learners Tab Content -->
    <section id="tab-learners" class="">
      <div class="flex gap-4 mb-4">
        <select id="programFilter" class="border p-2 rounded">
          <option value="">All Programs</option>
        </select>
        <select id="regionFilter" class="border p-2 rounded">
          <option value="">All Regions</option>
        </select>
        <button onclick="exportLearnersCSV()" class="bg-blue-600 text-white px-4 py-2 rounded">Export Learners CSV</button>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full bg-white shadow-md rounded-lg overflow-hidden">
          <thead>
            <tr class="bg-gray-200 text-left">
              <th class="p-3">Name</th>
              <th class="p-3">Email</th>
              <th class="p-3">Program</th>
              <th class="p-3">Region</th>
              <th class="p-3">Progress (%)</th>
              <th class="p-3">Approved</th>
              <th class="p-3">Actions</th>
            </tr>
          </thead>
          <tbody id="learnerTable"></tbody>
        </table>
      </div>
    </section>

    <!-- Courses Tab Content -->
    <section id="tab-courses" class="hidden">
      <div class="mb-4 flex justify-between items-center">
        <h2 class="text-xl font-bold">Courses</h2>
        <button onclick="addNewCourse()" class="bg-green-600 text-white px-4 py-2 rounded">Add New Course</button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white shadow-md rounded-lg overflow-hidden">
          <thead>
            <tr class="bg-gray-200 text-left">
              <th class="p-3">Course ID</th>
              <th class="p-3">Title</th>
              <th class="p-3">Description</th>
              <th class="p-3">Actions</th>
            </tr>
          </thead>
          <tbody id="courseTable"></tbody>
        </table>
      </div>
    </section>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getDatabase, ref, onValue, update, push, remove } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Elements
    const tabLearnersBtn = document.getElementById("tab-learners-btn");
    const tabCoursesBtn = document.getElementById("tab-courses-btn");
    const tabLearners = document.getElementById("tab-learners");
    const tabCourses = document.getElementById("tab-courses");

    const programFilter = document.getElementById("programFilter");
    const regionFilter = document.getElementById("regionFilter");

    const learnerTable = document.getElementById("learnerTable");
    const courseTable = document.getElementById("courseTable");

    // Data holders
    let allUsers = [];
    let allCourses = [];

    // Switch tabs
    tabLearnersBtn.addEventListener("click", () => {
      tabLearners.classList.remove("hidden");
      tabCourses.classList.add("hidden");
      tabLearnersBtn.classList.add("border-blue-600", "text-blue-600");
      tabCoursesBtn.classList.remove("border-blue-600", "text-blue-600");
    });

    tabCoursesBtn.addEventListener("click", () => {
      tabCourses.classList.remove("hidden");
      tabLearners.classList.add("hidden");
      tabCoursesBtn.classList.add("border-blue-600", "text-blue-600");
      tabLearnersBtn.classList.remove("border-blue-600", "text-blue-600");
    });

    // Authentication & admin check
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      // Check if user is admin
      const userRef = ref(db, `users/${user.uid}`);
      onValue(userRef, (snapshot) => {
        const data = snapshot.val();
        if (!data || data.role !== "admin") {
          alert("Access denied: Admins only.");
          signOut(auth).then(() => window.location.href = "login.html");
          return;
        }

        // Load data after admin verified
        loadLearners();
        loadCourses();
      }, { onlyOnce: true });
    });

    // Load learners data
    function loadLearners() {
      const usersRef = ref(db, "users");
      onValue(usersRef, (snapshot) => {
        const data = snapshot.val() || {};
        allUsers = [];
        const programs = new Set();
        const regions = new Set();

        for (const uid in data) {
          const user = data[uid];
          if (user.role === "learner") {
            allUsers.push({ ...user, uid });
            if (user.program) programs.add(user.program);
            if (user.region) regions.add(user.region);
          }
        }

        populateFilters(programs, regions);
        renderLearnersTable(allUsers);
      });
    }

    function populateFilters(programs, regions) {
      programFilter.innerHTML = `<option value="">All Programs</option>`;
      Array.from(programs).forEach(p => {
        programFilter.innerHTML += `<option value="${p}">${p}</option>`;
      });

      regionFilter.innerHTML = `<option value="">All Regions</option>`;
      Array.from(regions).forEach(r => {
        regionFilter.innerHTML += `<option value="${r}">${r}</option>`;
      });
    }

    function renderLearnersTable(users) {
      const filtered = users.filter(user =>
        (programFilter.value === "" || user.program === programFilter.value) &&
        (regionFilter.value === "" || user.region === regionFilter.value)
      );

      learnerTable.innerHTML = filtered.map(user => `
        <tr class="border-t">
          <td class="p-3">${user.fullName || "-"}</td>
          <td class="p-3">${user.email}</td>
          <td class="p-3">${user.program || "-"}</td>
          <td class="p-3">${user.region || "-"}</td>
          <td class="p-3">
            <input type="number" value="${user.progress || 0}" 
              min="0" max="100"
              onchange="updateProgress('${user.uid}', this.value)"
              class="w-16 border p-1 rounded text-center" />
          </td>
          <td class="p-3">${user.approved ? "✅" : "❌"}</td>
          <td class="p-3">
            ${!user.approved ? `<button class="bg-green-500 text-white px-3 py-1 rounded" onclick="approveUser('${user.uid}')">Approve</button>` : ""}
          </td>
        </tr>
      `).join("");
    }

    // Load courses data
    function loadCourses() {
      const coursesRef = ref(db, "courses");
      onValue(coursesRef, (snapshot) => {
        const data = snapshot.val() || {};
        allCourses = [];
        courseTable.innerHTML = "";

        for (const courseId in data) {
          const course = data[courseId];
          allCourses.push({ ...course, courseId });

          const row = document.createElement("tr");
          row.className = "border-t";
          row.innerHTML = `
            <td class="p-3">${courseId}</td>
            <td class="p-3"><input type="text" value="${course.title || ''}" onchange="updateCourseTitle('${courseId}', this.value)" class="border rounded p-1 w-full" /></td>
            <td class="p-3"><input type="text" value="${course.description || ''}" onchange="updateCourseDescription('${courseId}', this.value)" class="border rounded p-1 w-full" /></td>
            <td class="p-3">
              <button onclick="deleteCourse('${courseId}')" class="bg-red-600 text-white px-3 py-1 rounded">Delete</button>
            </td>
          `;
          courseTable.appendChild(row);
        }
      });
    }

    // Update learner progress
    window.updateProgress = async (uid, value) => {
      await update(ref(db, `users/${uid}`), { progress: parseInt(value) });
    };

    // Approve learner
    window.approveUser = async (uid) => {
      await update(ref(db, `users/${uid}`), { approved: true });
    };

    // Update course title
    window.updateCourseTitle = async (courseId, title) => {
      await update(ref(db, `courses/${courseId}`), { title });
    };

    // Update course description
    window.updateCourseDescription = async (courseId, description) => {
      await update(ref(db, `courses/${courseId}`), { description });
    };

    // Delete course
    window.deleteCourse = async (courseId) => {
      if (confirm("Are you sure you want to delete this course?")) {
        await remove(ref(db, `courses/${courseId}`));
      }
    };

    // Add new course
    window.addNewCourse = async () => {
      const newCourseRef = push(ref(db, "courses"));
      await newCourseRef.set({
        title: "New Course",
        description: "Course description",
      });
    };

    // Export learners CSV
    window.exportLearnersCSV = () => {
      const headers = ["Name", "Email", "Program", "Region", "Progress", "Approved"];
      const rows = allUsers.map(u => [
        `"${u.fullName || ''}"`,
        `"${u.email || ''}"`,
        `"${u.program || ''}"`,
        `"${u.region || ''}"`,
        `"${u.progress || 0}"`,
        `"${u.approved ? "Yes" : "No"}"`,
      ]);
      let csvContent = "data:text/csv;charset=utf-8," + [headers, ...rows].map(e => e.join(",")).join("\n");
      const link = document.createElement("a");
      link.setAttribute("href", encodeURI(csvContent));
      link.setAttribute("download", "ceta_learners.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    // Filters change handlers
    programFilter.addEventListener("change", () => renderLearnersTable(allUsers));
    regionFilter.addEventListener("change", () => renderLearnersTable(allUsers));

  </script>
</body>
</html>
