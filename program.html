<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CETA Provider Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <style>
    .sidebar {
      transition: transform 0.3s ease, width 0.3s ease;
      transform: translateX(0);
    }
    .sidebar-hidden {
      transform: translateX(-100%);
      width: 0;
    }
    .main-content {
      transition: margin-left 0.3s ease;
    }
    .high-contrast {
      background: #000 !important;
      color: #fff !important;
    }
    .high-contrast .bg-white {
      background: #1a1a1a !important;
    }
    .high-contrast .text-gray-600 {
      color: #e5e5e5 !important;
    }
    .tooltip {
      position: relative;
    }
    .tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #1f2937;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 10;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 100;
    }
    .modal-content {
      background: white;
      margin: 15% auto;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      border-radius: 8px;
    }
    .high-contrast .modal-content {
      background: #1a1a1a !important;
      color: #fff !important;
    }
    .error-modal {
      background: #fee2e2;
      border: 2px solid #dc2626;
    }
    .high-contrast .error-modal {
      background: #7f1d1d !important;
      color: #fff !important;
    }
    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 16px;
    }
    .pagination button {
      padding: 8px 16px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      background: #f3f4f6;
      cursor: pointer;
    }
    .pagination button:disabled {
      background: #e5e7eb;
      cursor: not-allowed;
    }
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        z-index: 50;
        width: 256px;
        transform: translateX(-100%);
      }
      .sidebar-open {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
      }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans min-h-screen">
  <div class="flex">
    <!-- Sidebar -->
    <div id="sidebar" class="sidebar bg-gradient-to-b from-gray-800 to-gray-900 text-white w-64 min-h-screen p-4 shadow-lg">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-xl font-bold flex items-center gap-2">
          <i class="fas fa-graduation-cap"></i> CETA Provider
        </h1>
        <button id="toggle-sidebar" class="md:hidden text-white focus:outline-none" aria-label="Toggle sidebar" aria-expanded="false">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
      <nav>
        <ul class="space-y-2">
          <li><button class="nav-button w-full text-left p-2 hover:bg-gray-700 rounded flex items-center gap-2" data-section="overview" data-tooltip="Dashboard Overview"><i class="fas fa-tachometer-alt"></i> Overview</button></li>
          <li><button class="nav-button w-full text-left p-2 hover:bg-gray-700 rounded flex items-center gap-2" data-section="learners" data-tooltip="Manage Learners"><i class="fas fa-users"></i> Manage Learners</button></li>
          <li><button class="nav-button w-full text-left p-2 hover:bg-gray-700 rounded flex items-center gap-2" data-section="courses" data-tooltip="Manage Courses"><i class="fas fa-book"></i> Manage Courses</button></li>
          <li><button class="nav-button w-full text-left p-2 hover:bg-gray-700 rounded flex items-center gap-2" data-section="progress" data-tooltip="Learner Progress"><i class="fas fa-chart-line"></i> Learner Progress</button></li>
          <li><button class="nav-button w-full text-left p-2 hover:bg-gray-700 rounded flex items-center gap-2" data-section="analytics" data-tooltip="Advanced Analytics"><i class="fas fa-chart-bar"></i> Analytics</button></li>
          <li><button class="nav-button w-full text-left p-2 hover:bg-gray-700 rounded flex items-center gap-2" data-section="helpdesk" data-tooltip="Support Tickets"><i class="fas fa-headset"></i> Helpdesk</button></li>
        </ul>
      </nav>
      <div class="mt-auto">
        <button id="toggle-contrast" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded mb-2" aria-label="Toggle high contrast mode" data-tooltip="Toggle High Contrast">Toggle High Contrast</button>
        <button id="signout-btn" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded" aria-label="Sign out of provider account" data-tooltip="Sign Out">Sign Out</button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content flex-1 p-6 md:ml-64">
      <!-- Overview Section -->
      <div id="overview" class="section">
        <h2 class="text-2xl font-semibold mb-4">Welcome, <span id="provider-name">Provider</span></h2>
        <div class="grid gap-4 md:grid-cols-4">
          <div class="bg-white p-4 rounded shadow hover:shadow-md transition-shadow">
            <h3 class="text-lg font-semibold">Courses Offered</h3>
            <p id="courses-offered" class="text-3xl font-bold text-blue-600">0</p>
          </div>
          <div class="bg-white p-4 rounded shadow hover:shadow-md transition-shadow">
            <h3 class="text-lg font-semibold">Enrolled Learners</h3>
            <p id="enrolled-learners" class="text-3xl font-bold text-blue-600">0</p>
          </div>
          <div class="bg-white p-4 rounded shadow hover:shadow-md transition-shadow">
            <h3 class="text-lg font-semibold">Completion Rate</h3>
            <p id="completion-rate" class="text-3xl font-bold text-blue-600">0%</p>
          </div>
          <div class="bg-white p-4 rounded shadow hover:shadow-md transition-shadow">
            <h3 class="text-lg font-semibold">Certificates Issued</h3>
            <p id="certificates-issued" class="text-3xl font-bold text-blue-600">0</p>
          </div>
        </div>
        <div class="mt-6 bg-white p-4 rounded shadow">
          <h3 class="text-lg font-semibold mb-2">Course Completion Rates</h3>
          <canvas id="completion-chart" class="w-full h-64"></canvas>
        </div>
        <div class="mt-6 bg-white p-4 rounded shadow">
          <h3 class="text-lg font-semibold mb-2">Enrollment Trends</h3>
          <canvas id="enrollment-trend-chart" class="w-full h-64"></canvas>
        </div>
      </div>

      <!-- Learners Section -->
      <div id="learners" class="section hidden">
        <h2 class="text-2xl font-semibold mb-4">Manage Learners</h2>
        <div class="mb-4 bg-white p-6 rounded shadow">
          <h3 class="text-lg font-semibold mb-2">Add New Learner</h3>
          <button id="open-add-learner" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" data-tooltip="Add new learner">Add Learner</button>
          <button id="open-bulk-upload" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 ml-2" data-tooltip="Upload learners via CSV">Bulk Upload</button>
        </div>
        <div class="mb-4 bg-white p-6 rounded shadow">
          <h3 class="text-lg font-semibold mb-2">Learner List</h3>
          <input type="text" id="learnerSearch" placeholder="Search learners..." class="border p-2 rounded w-full mb-4" aria-label="Search learners by name, email, or tag" />
          <select id="groupFilter" class="border p-2 rounded mb-4" aria-label="Filter by group">
            <option value="">All Groups</option>
          </select>
          <div id="learnerList" class="space-y-4"></div>
          <div id="learnerPagination" class="pagination"></div>
        </div>
      </div>

      <!-- Courses Section -->
      <div id="courses" class="section hidden">
        <h2 class="text-2xl font-semibold mb-4">Manage Courses</h2>
        <div class="mb-4 bg-white p-6 rounded shadow">
          <h3 class="text-lg font-semibold mb-2">Add New Course</h3>
          <form id="course-form">
            <input type="text" id="courseName" placeholder="Course Name" class="border p-2 rounded w-full mb-2" aria-label="Enter course name" required />
            <input type="text" id="courseTags" placeholder="Tags (comma-separated)" class="border p-2 rounded w-full mb-2" aria-label="Enter course tags" />
            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" data-tooltip="Add new course">Add Course</button>
          </form>
        </div>
        <div class="mb-4 bg-white p-6 rounded shadow">
          <h3 class="text-lg font-semibold mb-2">Course List</h3>
          <input type="text" id="courseSearch" placeholder="Search courses..." class="border p-2 rounded w-full mb-4" aria-label="Search courses by name or tag" />
          <div id="courseList" class="space-y-4"></div>
          <div id="coursePagination" class="pagination"></div>
        </div>
      </div>

      <!-- Learner Progress Section -->
      <div id="progress" class="section hidden">
        <h2 class="text-2xl font-semibold mb-4">Learner Progress</h2>
        <div class="bg-white p-6 rounded shadow">
          <h3 class="text-lg font-semibold mb-2">Learner Progress</h3>
          <input type="text" id="progressSearch" placeholder="Search learners..." class="border p-2 rounded w-full mb-4" aria-label="Search learners by name or email" />
          <div id="progressList" class="space-y-4"></div>
        </div>
      </div>

      <!-- Analytics Section -->
      <div id="analytics" class="section hidden">
        <h2 class="text-2xl font-semibold mb-4">Advanced Analytics</h2>
        <div class="mb-4 bg-white p-6 rounded shadow">
          <h3 class="text-lg font-semibold mb-2">Filter Analytics</h3>
          <div class="flex flex-wrap gap-4 mb-4">
            <select id="timeRange" class="border p-2 rounded" aria-label="Select time range">
              <option value="30">Last 30 Days</option>
              <option value="90">Last 90 Days</option>
              <option value="365">Last Year</option>
              <option value="all">All Time</option>
            </select>
            <select id="courseFilter" class="border p-2 rounded" aria-label="Select course"></select>
            <select id="groupFilterAnalytics" class="border p-2 rounded" aria-label="Select learner group">
              <option value="">All Groups</option>
            </select>
            <select id="chartType" class="border p-2 rounded" aria-label="Select chart type">
              <option value="bar">Bar Chart</option>
              <option value="line">Line Chart</option>
            </select>
            <button id="export-analytics" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700" data-tooltip="Export analytics to PDF">Export to PDF</button>
          </div>
        </div>
        <div class="bg-white p-6 rounded shadow">
          <h3 class="text-lg font-semibold mb-2">Course Performance</h3>
          <canvas id="analytics-chart" class="w-full h-64"></canvas>
          <h3 class="text-lg font-semibold mt-4 mb-2">Learner Activity Heatmap</h3>
          <canvas id="heatmap-chart" class="w-full h-64"></canvas>
          <h3 class="text-lg font-semibold mt-4 mb-2">Statistical Metrics</h3>
          <div id="analytics-details" class="space-y-4"></div>
        </div>
      </div>

      <!-- Helpdesk Section -->
      <div id="helpdesk" class="section hidden">
        <h2 class="text-2xl font-semibold mb-4">Helpdesk</h2>
        <div class="bg-white p-6 rounded shadow">
          <h3 class="text-lg font-semibold mb-2">Support Tickets</h3>
          <div id="ticketList" class="space-y-4"></div>
        </div>
      </div>

      <!-- Add Learner Modal -->
      <div id="add-learner-modal" class="modal">
        <div class="modal-content">
          <h3 class="text-lg font-semibold mb-4">Add New Learner</h3>
          <form id="add-learner-form">
            <input type="text" id="learnerFullName" placeholder="Full Name" class="border p-2 rounded w-full mb-2" aria-label="Enter learner full name" required />
            <input type="email" id="learnerEmail" placeholder="Email" class="border p-2 rounded w-full mb-2" aria-label="Enter learner email" required />
            <input type="text" id="learnerContact" placeholder="Contact Number (optional)" class="border p-2 rounded w-full mb-2" aria-label="Enter learner contact number" />
            <input type="text" id="learnerTags" placeholder="Tags (comma-separated, optional)" class="border p-2 rounded w-full mb-2" aria-label="Enter learner tags" />
            <select id="learnerCourse" class="border p-2 rounded w-full mb-2" aria-label="Select course">
              <option value="">Select Course (optional)</option>
            </select>
            <div class="flex gap-2">
              <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" data-tooltip="Save learner">Save</button>
              <button type="button" id="close-add-learner" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700" data-tooltip="Cancel">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Bulk Upload Modal -->
      <div id="bulk-upload-modal" class="modal">
        <div class="modal-content">
          <h3 class="text-lg font-semibold mb-4">Bulk Upload Learners</h3>
          <form id="bulk-upload-form">
            <input type="file" id="learnerCSV" accept=".csv" class="border p-2 rounded w-full mb-2" aria-label="Upload CSV file" required />
            <p class="text-sm text-gray-600 mb-2">CSV format: fullName,email,contact,tags,courseId</p>
            <div class="flex gap-2">
              <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" data-tooltip="Upload CSV">Upload</button>
              <button type="button" id="close-bulk-upload" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700" data-tooltip="Cancel">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Error Modal -->
      <div id="error-modal" class="modal">
        <div class="modal-content error-modal">
          <h3 class="text-lg font-semibold mb-4 text-red-600">Error</h3>
          <p id="error-message" class="text-sm text-gray-600"></p>
          <button id="close-error" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 mt-4" data-tooltip="Close error">Close</button>
        </div>
      </div>

      <div id="loading-spinner" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-600"></div>
      </div>

      <noscript>
        <p class="text-red-600 text-center">JavaScript is required to use this dashboard.</p>
      </noscript>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getDatabase, ref, onValue, push, update, set, get, remove, runTransaction } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    // Firebase configuration (replace with environment variables in production)
    const firebaseConfig = {
      apiKey: process.env.FIREBASE_API_KEY || "your-api-key",
      authDomain: process.env.FIREBASE_AUTH_DOMAIN || "your-auth-domain",
      databaseURL: process.env.FIREBASE_DATABASE_URL || "your-database-url",
      projectId: process.env.FIREBASE_PROJECT_ID || "your-project-id",
      storageBucket: process.env.FIREBASE_STORAGE_BUCKET || "your-storage-bucket",
      messagingSenderId: process.env.FIREBASE_MESSAGING_SENDER_ID || "your-messaging-sender-id",
      appId: process.env.FIREBASE_APP_ID || "your-app-id"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // DOM elements
    const dom = {
      providerName: document.getElementById("provider-name"),
      coursesOffered: document.getElementById("courses-offered"),
      enrolledLearners: document.getElementById("enrolled-learners"),
      completionRate: document.getElementById("completion-rate"),
      certificatesIssued: document.getElementById("certificates-issued"),
      courseList: document.getElementById("courseList"),
      courseSearch: document.getElementById("courseSearch"),
      coursePagination: document.getElementById("coursePagination"),
      learnerList: document.getElementById("learnerList"),
      learnerSearch: document.getElementById("learnerSearch"),
      groupFilter: document.getElementById("groupFilter"),
      learnerPagination: document.getElementById("learnerPagination"),
      progressList: document.getElementById("progressList"),
      progressSearch: document.getElementById("progressSearch"),
      ticketList: document.getElementById("ticketList"),
      courseForm: document.getElementById("course-form"),
      courseName: document.getElementById("courseName"),
      courseTags: document.getElementById("courseTags"),
      addLearnerModal: document.getElementById("add-learner-modal"),
      addLearnerForm: document.getElementById("add-learner-form"),
      learnerFullName: document.getElementById("learnerFullName"),
      learnerEmail: document.getElementById("learnerEmail"),
      learnerContact: document.getElementById("learnerContact"),
      learnerTags: document.getElementById("learnerTags"),
      learnerCourse: document.getElementById("learnerCourse"),
      closeAddLearner: document.getElementById("close-add-learner"),
      bulkUploadModal: document.getElementById("bulk-upload-modal"),
      bulkUploadForm: document.getElementById("bulk-upload-form"),
      learnerCSV: document.getElementById("learnerCSV"),
      closeBulkUpload: document.getElementById("close-bulk-upload"),
      errorModal: document.getElementById("error-modal"),
      errorMessage: document.getElementById("error-message"),
      closeError: document.getElementById("close-error"),
      completionChart: document.getElementById("completion-chart").getContext("2d"),
      enrollmentTrendChart: document.getElementById("enrollment-trend-chart").getContext("2d"),
      analyticsChart: document.getElementById("analytics-chart").getContext("2d"),
      heatmapChart: document.getElementById("heatmap-chart").getContext("2d"),
      analyticsDetails: document.getElementById("analytics-details"),
      timeRange: document.getElementById("timeRange"),
      courseFilter: document.getElementById("courseFilter"),
      groupFilterAnalytics: document.getElementById("groupFilterAnalytics"),
      chartType: document.getElementById("chartType"),
      exportAnalytics: document.getElementById("export-analytics"),
      loadingSpinner: document.getElementById("loading-spinner"),
      sidebar: document.getElementById("sidebar"),
      toggleSidebar: document.getElementById("toggle-sidebar"),
      toggleContrast: document.getElementById("toggle-contrast"),
      openAddLearner: document.getElementById("open-add-learner"),
      openBulkUpload: document.getElementById("open-bulk-upload"),
      signoutBtn: document.getElementById("signout-btn")
    };

    let user = null, courses = {}, learners = {}, assessments = {}, certifications = {}, tickets = {}, notifications = [];
    let completionChartInstance = null, enrollmentTrendChartInstance = null, analyticsChartInstance = null, heatmapChartInstance = null;
    const itemsPerPage = 10;
    let learnerPage = 1, coursePage = 1;

    // Utility Functions
    function showSpinner() { dom.loadingSpinner.classList.remove("hidden"); }
    function hideSpinner() { dom.loadingSpinner.classList.add("hidden"); }

    function showError(message) {
      dom.errorMessage.textContent = message;
      dom.errorModal.style.display = "block";
      dom.closeError.focus();
    }

    function hideError() {
      dom.errorModal.style.display = "none";
      dom.errorMessage.textContent = "";
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function sanitizeInput(input) {
      const div = document.createElement("div");
      div.textContent = input;
      return div.innerHTML;
    }

    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    function validateTags(tags) {
      return tags.split(",").every(tag => tag.trim().length <= 50);
    }

    // UI Event Handlers
    function setupUIEvents() {
      dom.toggleSidebar.addEventListener("click", () => {
        dom.sidebar.classList.toggle("sidebar-hidden");
        dom.sidebar.classList.toggle("sidebar-open");
        const isOpen = dom.sidebar.classList.contains("sidebar-open");
        dom.toggleSidebar.setAttribute("aria-expanded", isOpen);
      });

      dom.toggleContrast.addEventListener("click", () => {
        document.body.classList.toggle("high-contrast");
        localStorage.setItem("highContrast", document.body.classList.contains("high-contrast"));
      });

      if (localStorage.getItem("highContrast") === "true") {
        document.body.classList.add("high-contrast");
      }

      document.querySelectorAll(".nav-button").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".section").forEach(section => section.classList.add("hidden"));
          document.getElementById(btn.dataset.section).classList.remove("hidden");
          if (window.innerWidth < 768) dom.sidebar.classList.remove("sidebar-open");
          dom.toggleSidebar.setAttribute("aria-expanded", "false");
        });
      });

      dom.closeError.addEventListener("click", hideError);
    }

    // Authentication
    async function checkAuth() {
      onAuthStateChanged(auth, async authUser => {
        if (!authUser) {
          showError("Unauthorized. Redirecting to login...");
          setTimeout(() => window.location.href = "login.html", 2000);
          return;
        }
        try {
          const userSnap = await get(ref(db, `users/${authUser.uid}`));
          if (userSnap.exists()) {
            user = userSnap.val();
            if (user.role !== "provider") {
              showError("Access denied. Provider role required. Redirecting...");
              setTimeout(() => { signOut(auth); window.location.href = "login.html"; }, 2000);
              return;
            }
            dom.providerName.textContent = sanitizeInput(user.fullName || user.email);
            loadOverview();
            loadLearners();
            loadCourses();
            loadLearnerProgress();
            loadAnalytics();
            loadTickets();
          } else {
            showError("User data not found. Redirecting...");
            setTimeout(() => { signOut(auth); window.location.href = "login.html"; }, 2000);
          }
        } catch (err) {
          console.error("Error fetching user data:", err);
          showError("Failed to load user data. Redirecting...");
          setTimeout(() => { signOut(auth); window.location.href = "login.html"; }, 2000);
        }
      });

      dom.signoutBtn.addEventListener("click", async () => {
        try {
          await signOut(auth);
          window.location.href = "login.html";
        } catch (err) {
          console.error("Sign-out failed:", err);
          showError("Failed to sign out. Please try again.");
        }
      });
    }

    // Overview
    function loadOverview() {
      showSpinner();
      onValue(ref(db, `users/${auth.currentUser.uid}`), snap => {
        user = snap.val();
        dom.providerName.textContent = sanitizeInput(user.fullName || user.email);
      });

      onValue(ref(db, "courses"), snap => {
        courses = snap.val() || {};
        let courseCount = 0, learnerCount = 0, completedCount = 0, certCount = 0;
        const completionData = { labels: [], datasets: [{ label: "Completion Rate (%)", data: [], backgroundColor: "#2563eb", borderRadius: 4 }] };
        const enrollmentData = { labels: [], datasets: [{ label: "Enrollments", data: [], backgroundColor: "#10b981", borderRadius: 4 }] };

        const now = Date.now();
        const days = 30;
        const timePoints = Array.from({ length: days }, (_, i) => {
          const date = new Date(now - (days - i - 1) * 24 * 60 * 60 * 1000);
          return date.toLocaleDateString();
        });

        const enrollmentsByDay = timePoints.map(() => 0);

        for (const id in courses) {
          if (courses[id].providerId === auth.currentUser.uid && !courses[id].archived) {
            courseCount++;
            const enrolled = courses[id].enrolled?.length || 0;
            learnerCount += enrolled;
            const completion = courses[id].completions?.length || 0;
            completionData.labels.push(courses[id].name);
            completionData.datasets[0].data.push(enrolled > 0 ? (completion / enrolled * 100).toFixed(1) : 0);
            completedCount += completion;

            courses[id].enrolled?.forEach(learnerId => {
              const enrollmentDate = learners[learnerId]?.enrollmentDate || now;
              const daysSince = Math.floor((now - enrollmentDate) / (24 * 60 * 60 * 1000));
              if (daysSince < days) enrollmentsByDay[days - daysSince - 1]++;
            });
          }
        }

        dom.coursesOffered.textContent = courseCount;
        dom.enrolledLearners.textContent = learnerCount;
        dom.completionRate.textContent = learnerCount > 0 ? (completedCount / learnerCount * 100).toFixed(1) + "%" : "0%";

        if (completionChartInstance) completionChartInstance.destroy();
        completionChartInstance = new Chart(dom.completionChart, {
          type: "bar",
          data: completionData,
          options: {
            scales: { y: { beginAtZero: true, max: 100 } },
            plugins: {
              datalabels: { anchor: "end", align: "top", color: "#374151", font: { weight: "bold" } }
            }
          },
          plugins: [ChartDataLabels]
        });

        if (enrollmentTrendChartInstance) enrollmentTrendChartInstance.destroy();
        enrollmentTrendChartInstance = new Chart(dom.enrollmentTrendChart, {
          type: "line",
          data: {
            labels: timePoints,
            datasets: [{ label: "Enrollments", data: enrollmentsByDay, borderColor: "#10b981", fill: false }]
          },
          options: {
            scales: { y: { beginAtZero: true } },
            plugins: { tooltip: { mode: "index", intersect: false } }
          }
        });

        onValue(ref(db, "certifications"), snap => {
          certifications = snap.val() || {};
          certCount = Object.values(certifications).filter(c => courses[c.courseId]?.providerId === auth.currentUser.uid).length;
          dom.certificatesIssued.textContent = certCount;
          hideSpinner();
        });
      });
    }

    // Learners
    function loadLearners() {
      showSpinner();
      onValue(ref(db, "users"), snap => {
        learners = snap.val() || {};
        onValue(ref(db, "courses"), snap => {
          courses = snap.val() || {};
          renderLearners();
          populateGroupFilter();
          populateCourseFilter();
          populateLearnerCourseDropdown();
          hideSpinner();
        });
      });
    }

    function renderLearners(filter = "", group = "", page = learnerPage) {
      dom.learnerList.innerHTML = "";
      const filteredLearners = Object.entries(learners).filter(([id, l]) => {
        if (l.role !== "learner" || l.providerId !== auth.currentUser.uid) return false;
        if (filter && !l.fullName?.toLowerCase().includes(filter.toLowerCase()) && !l.email.toLowerCase().includes(filter.toLowerCase()) && !l.metadata?.tags?.some(t => t.toLowerCase().includes(filter.toLowerCase()))) return false;
        if (group && !l.metadata?.tags?.includes(group)) return false;
        return true;
      });

      const totalPages = Math.ceil(filteredLearners.length / itemsPerPage);
      const start = (page - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const paginatedLearners = filteredLearners.slice(start, end);

      paginatedLearners.forEach(([id, l]) => {
        const learnerItem = document.createElement("div");
        learnerItem.className = "bg-gray-50 p-4 rounded shadow hover:shadow-md transition-shadow";
        const enrolledCourses = Object.values(courses).filter(c => c.providerId === auth.currentUser.uid && c.enrolled?.includes(id));
        learnerItem.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <p class="font-semibold">${sanitizeInput(l.fullName || l.email)}</p>
              <p class="text-sm text-gray-600">Email: ${sanitizeInput(l.email)} | Contact: ${sanitizeInput(l.metadata?.contact || "-")} | Tags: ${sanitizeInput(l.metadata?.tags?.join(", ") || "-")}</p>
              <p class="text-sm text-gray-600">Courses: ${enrolledCourses.map(c => sanitizeInput(c.name)).join(", ") || "None"}</p>
            </div>
            <div class="flex gap-2">
              <button onclick="viewLearnerProfile('${id}')" class="text-blue-600 hover:underline" aria-label="View profile for ${sanitizeInput(l.fullName || l.email)}" data-tooltip="View profile">Profile</button>
              <button onclick="editLearner('${id}')" class="text-blue-600 hover:underline" aria-label="Edit learner ${sanitizeInput(l.fullName || l.email)}" data-tooltip="Edit learner">Edit</button>
              <button onclick="deleteLearner('${id}')" class="text-red-600 hover:underline" aria-label="Delete learner ${sanitizeInput(l.fullName || l.email)}" data-tooltip="Delete learner">Delete</button>
            </div>
          </div>
        `;
        dom.learnerList.appendChild(learnerItem);
      });

      renderPagination(dom.learnerPagination, page, totalPages, newPage => {
        learnerPage = newPage;
        renderLearners(filter, group, newPage);
      });
    }

    function renderPagination(container, currentPage, totalPages, onPageChange) {
      container.innerHTML = "";
      const prevButton = document.createElement("button");
      prevButton.textContent = "Previous";
      prevButton.disabled = currentPage === 1;
      prevButton.addEventListener("click", () => onPageChange(currentPage - 1));
      container.appendChild(prevButton);

      for (let i = 1; i <= totalPages; i++) {
        const pageButton = document.createElement("button");
        pageButton.textContent = i;
        pageButton.disabled = i === currentPage;
        pageButton.addEventListener("click", () => onPageChange(i));
        container.appendChild(pageButton);
      }

      const nextButton = document.createElement("button");
      nextButton.textContent = "Next";
      nextButton.disabled = currentPage === totalPages;
      nextButton.addEventListener("click", () => onPageChange(currentPage + 1));
      container.appendChild(nextButton);
    }

    const searchLearners = debounce((filter, group) => renderLearners(sanitizeInput(filter), group), 300);
    dom.learnerSearch.addEventListener("input", () => searchLearners(dom.learnerSearch.value, dom.groupFilter.value));
    dom.groupFilter.addEventListener("change", () => searchLearners(dom.learnerSearch.value, dom.groupFilter.value));

    function populateGroupFilter() {
      const groups = new Set();
      for (const id in learners) {
        if (learners[id].role === "learner" && learners[id].providerId === auth.currentUser.uid) {
          learners[id].metadata?.tags?.forEach(tag => groups.add(tag));
        }
      }
      dom.groupFilter.innerHTML = '<option value="">All Groups</option>';
      groups.forEach(group => {
        const option = document.createElement("option");
        option.value = group;
        option.textContent = sanitizeInput(group);
        dom.groupFilter.appendChild(option);
      });
      dom.groupFilterAnalytics.innerHTML = dom.groupFilter.innerHTML;
    }

    function populateLearnerCourseDropdown() {
      dom.learnerCourse.innerHTML = '<option value="">Select Course (optional)</option>';
      for (const id in courses) {
        if (courses[id].providerId === auth.currentUser.uid && !courses[id].archived) {
          const option = document.createElement("option");
          option.value = id;
          option.textContent = sanitizeInput(courses[id].name);
          dom.learnerCourse.appendChild(option);
        }
      }
    }

    dom.openAddLearner.addEventListener("click", () => {
      dom.addLearnerModal.style.display = "block";
      dom.learnerFullName.focus();
    });

    dom.closeAddLearner.addEventListener("click", () => {
      dom.addLearnerModal.style.display = "none";
      dom.addLearnerForm.reset();
    });

    dom.addLearnerForm.addEventListener("submit", async e => {
      e.preventDefault();
      const fullName = sanitizeInput(dom.learnerFullName.value.trim());
      const email = sanitizeInput(dom.learnerEmail.value.trim());
      const contact = sanitizeInput(dom.learnerContact.value.trim());
      const tags = dom.learnerTags.value.split(",").map(t => sanitizeInput(t.trim())).filter(t => t);
      const courseId = dom.learnerCourse.value;

      if (!fullName) return showError("Full name is required.");
      if (!email) return showError("Email is required.");
      if (!validateEmail(email)) return showError("Invalid email format.");
      if (!validateTags(dom.learnerTags.value)) return showError("Each tag must be 50 characters or less.");

      showSpinner();
      try {
        const { user: newUser } = await createUserWithEmailAndPassword(auth, email, generateTempPassword());
        await set(ref(db, `users/${newUser.uid}`), {
          fullName,
          email,
          role: "learner",
          providerId: auth.currentUser.uid,
          enrollmentDate: Date.now(),
          progress: {},
          metadata: { contact: contact || null, tags, version: "1.0" }
        });
        if (courseId) {
          await runTransaction(ref(db, `courses/${courseId}`), course => {
            course = course || { enrolled: [] };
            course.enrolled = course.enrolled || [];
            if (!course.enrolled.includes(newUser.uid)) course.enrolled.push(newUser.uid);
            return course;
          });
        }
        logAudit(`Added learner ${fullName} (${email})`);
        dom.addLearnerModal.style.display = "none";
        dom.addLearnerForm.reset();
      } catch (err) {
        console.error("Error adding learner:", err);
        showError(`Failed to add learner: ${err.message}`);
      }
      hideSpinner();
    });

    function generateTempPassword() {
      return Math.random().toString(36).slice(-8);
    }

    dom.openBulkUpload.addEventListener("click", () => {
      dom.bulkUploadModal.style.display = "block";
    });

    dom.closeBulkUpload.addEventListener("click", () => {
      dom.bulkUploadModal.style.display = "none";
      dom.bulkUploadForm.reset();
    });

    dom.bulkUploadForm.addEventListener("submit", async e => {
      e.preventDefault();
      const file = dom.learnerCSV.files[0];
      if (!file) return showError("Please select a CSV file.");
      showSpinner();
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: async results => {
          try {
            for (const row of results.data) {
              const fullName = sanitizeInput(row.fullName?.trim() || "");
              const email = sanitizeInput(row.email?.trim() || "");
              const contact = sanitizeInput(row.contact?.trim() || "");
              const tags = row.tags ? row.tags.split(",").map(t => sanitizeInput(t.trim())).filter(t => t) : [];
              const courseId = row.courseId?.trim();
              if (!fullName || !email) continue;
              if (!validateEmail(email)) {
                console.warn(`Skipping invalid email: ${email}`);
                continue;
              }
              if (!validateTags(row.tags || "")) {
                console.warn(`Skipping invalid tags for ${email}`);
                continue;
              }
              const { user: newUser } = await createUserWithEmailAndPassword(auth, email, generateTempPassword());
              await set(ref(db, `users/${newUser.uid}`), {
                fullName,
                email,
                role: "learner",
                providerId: auth.currentUser.uid,
                enrollmentDate: Date.now(),
                progress: {},
                metadata: { contact: contact || null, tags, version: "1.0" }
              });
              if (courseId && courses[courseId]?.providerId === auth.currentUser.uid) {
                await runTransaction(ref(db, `courses/${courseId}`), course => {
                  course = course || { enrolled: [] };
                  course.enrolled = course.enrolled || [];
                  if (!course.enrolled.includes(newUser.uid)) course.enrolled.push(newUser.uid);
                  return course;
                });
              }
              logAudit(`Bulk added learner ${fullName} (${email})`);
            }
            dom.bulkUploadModal.style.display = "none";
            dom.bulkUploadForm.reset();
          } catch (err) {
            console.error("Error during bulk upload:", err);
            showError(`Failed to upload some learners: ${err.message}`);
          }
          hideSpinner();
        },
        error: err => {
          console.error("CSV parsing error:", err);
          showError("Failed to parse CSV file.");
          hideSpinner();
        }
      });
    });

    window.editLearner = async learnerId => {
      const l = learners[learnerId];
      dom.learnerFullName.value = l.fullName || "";
      dom.learnerEmail.value = l.email;
      dom.learnerContact.value = l.metadata?.contact || "";
      dom.learnerTags.value = l.metadata?.tags?.join(", ") || "";
      dom.learnerCourse.value = Object.keys(courses).find(id => courses[id].enrolled?.includes(learnerId)) || "";
      dom.addLearnerModal.style.display = "block";
      dom.addLearnerForm.onsubmit = async e => {
        e.preventDefault();
        const fullName = sanitizeInput(dom.learnerFullName.value.trim());
        const email = sanitizeInput(dom.learnerEmail.value.trim());
        const contact = sanitizeInput(dom.learnerContact.value.trim());
        const tags = dom.learnerTags.value.split(",").map(t => sanitizeInput(t.trim())).filter(t => t);
        const newCourseId = dom.learnerCourse.value;

        if (!fullName) return showError("Full name is required.");
        if (!email) return showError("Email is required.");
        if (!validateEmail(email)) return showError("Invalid email format.");
        if (!validateTags(dom.learnerTags.value)) return showError("Each tag must be 50 characters or less.");

        showSpinner();
        try {
          await update(ref(db, `users/${learnerId}`), {
            fullName,
            email,
            metadata: { contact: contact || null, tags, version: "1.1" }
          });
          const oldCourseId = Object.keys(courses).find(id => courses[id].enrolled?.includes(learnerId));
          if (oldCourseId !== newCourseId) {
            if (oldCourseId) {
              await runTransaction(ref(db, `courses/${oldCourseId}`), course => {
                course = course || { enrolled: [] };
                course.enrolled = course.enrolled.filter(id => id !== learnerId);
                return course;
              });
            }
            if (newCourseId) {
              await runTransaction(ref(db, `courses/${newCourseId}`), course => {
                course = course || { enrolled: [] };
                course.enrolled = course.enrolled || [];
                if (!course.enrolled.includes(learnerId)) course.enrolled.push(learnerId);
                return course;
              });
            }
          }
          logAudit(`Edited learner ${fullName} (${email})`);
          dom.addLearnerModal.style.display = "none";
          dom.addLearnerForm.reset();
          dom.addLearnerForm.onsubmit = null;
        } catch (err) {
          console.error("Error editing learner:", err);
          showError(`Failed to edit learner: ${err.message}`);
        }
        hideSpinner();
      };
    };

    window.deleteLearner = async learnerId => {
      if (!confirm("Are you sure you want to delete this learner?")) return;
      showSpinner();
      try {
        await remove(ref(db, `users/${learnerId}`));
        for (const courseId in courses) {
          if (courses[courseId].enrolled?.includes(learnerId)) {
            await runTransaction(ref(db, `courses/${courseId}`), course => {
              course = course || { enrolled: [] };
              course.enrolled = course.enrolled.filter(id => id !== learnerId);
              return course;
            });
          }
        }
        logAudit(`Deleted learner ${learners[learnerId].fullName || learners[learnerId].email}`);
      } catch (err) {
        console.error("Error deleting learner:", err);
        showError(`Failed to delete learner: ${err.message}`);
      }
      hideSpinner();
    };

    window.viewLearnerProfile = learnerId => {
      const l = learners[learnerId];
      const enrolledCourses = Object.values(courses).filter(c => c.providerId === auth.currentUser.uid && c.enrolled?.includes(learnerId));
      const certs = Object.values(certifications).filter(c => c.learnerId === learnerId && courses[c.courseId]?.providerId === auth.currentUser.uid);
      const activityLogs = notifications.filter(n => n.learnerId === learnerId);
      const modal = document.createElement("div");
      modal.className = "modal";
      modal.style.display = "block";
      modal.innerHTML = `
        <div class="modal-content">
          <h3 class="text-lg font-semibold mb-4">Learner Profile: ${sanitizeInput(l.fullName || l.email)}</h3>
          <p class="text-sm text-gray-600">Email: ${sanitizeInput(l.email)}</p>
          <p class="text-sm text-gray-600">Contact: ${sanitizeInput(l.metadata?.contact || "-")}</p>
          <p class="text-sm text-gray-600">Tags: ${sanitizeInput(l.metadata?.tags?.join(", ") || "-")}</p>
          <p class="text-sm text-gray-600">Enrolled Courses: ${enrolledCourses.map(c => sanitizeInput(c.name)).join(", ") || "None"}</p>
          <p class="text-sm text-gray-600">Certificates: ${certs.map(c => `<a href="#" onclick="downloadCertificate('${c.id}')" class="text-blue-600 hover:underline">${sanitizeInput(courses[c.courseId].name)}</a>`).join(", ") || "None"}</p>
          <h4 class="text-md font-semibold mt-4 mb-2">Activity Log</h4>
          <ul class="text-sm text-gray-600 space-y-1">${activityLogs.map(n => `<li>${sanitizeInput(n.message)} (${new Date(n.timestamp).toLocaleString()})</li>`).join("") || "No activity"}</ul>
          <button class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 mt-4" onclick="this.parentElement.parentElement.remove()" data-tooltip="Close profile">Close</button>
        </div>
      `;
      document.body.appendChild(modal);
    };

    // Courses
    function loadCourses() {
      showSpinner();
      onValue(ref(db, "courses"), snap => {
        courses = snap.val() || {};
        renderCourses();
        populateCourseFilter();
        populateLearnerCourseDropdown();
        hideSpinner();
      });
    }

    function renderCourses(filter = "", page = coursePage) {
      dom.courseList.innerHTML = "";
      const filteredCourses = Object.entries(courses).filter(([id, c]) => {
        if (c.providerId !== auth.currentUser.uid || (filter && !c.name.toLowerCase().includes(filter.toLowerCase()) && !c.metadata?.tags?.some(t => t.toLowerCase().includes(filter.toLowerCase())))) return false;
        return true;
      });

      const totalPages = Math.ceil(filteredCourses.length / itemsPerPage);
      const start = (page - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const paginatedCourses = filteredCourses.slice(start, end);

      paginatedCourses.forEach(([id, c]) => {
        const courseItem = document.createElement("div");
        courseItem.className = "bg-gray-50 p-4 rounded shadow flex justify-between items-center hover:shadow-md transition-shadow";
        courseItem.innerHTML = `
          <div>
            <p class="font-semibold">${sanitizeInput(c.name)}</p>
            <p class="text-sm text-gray-600">Tags: ${sanitizeInput(c.metadata?.tags?.join(", ") || "-")} | Enrolled: ${c.enrolled?.length || 0}</p>
          </div>
          <div class="flex gap-2">
            <button onclick="editCourse('${id}')" class="text-blue-600 hover:underline" aria-label="Edit course ${sanitizeInput(c.name)}" data-tooltip="Edit course">Edit</button>
            <button onclick="archiveCourse('${id}')" class="text-red-600 hover:underline" aria-label="${c.archived ? "Unarchive" : "Archive"} course ${sanitizeInput(c.name)}" data-tooltip="${c.archived ? "Unarchive" : "Archive"} course">${c.archived ? "Unarchive" : "Archive"}</button>
          </div>
        `;
        dom.courseList.appendChild(courseItem);
      });

      renderPagination(dom.coursePagination, page, totalPages, newPage => {
        coursePage = newPage;
        renderCourses(filter, newPage);
      });
    }

    const searchCourses = debounce(filter => renderCourses(sanitizeInput(filter)), 300);
    dom.courseSearch.addEventListener("input", () => searchCourses(dom.courseSearch.value));

    dom.courseForm.addEventListener("submit", async e => {
      e.preventDefault();
      const name = sanitizeInput(dom.courseName.value.trim());
      const tags = dom.courseTags.value.split(",").map(t => sanitizeInput(t.trim())).filter(t => t);

      if (!name) return showError("Course name is required.");
      if (!validateTags(dom.courseTags.value)) return showError("Each tag must be 50 characters or less.");

      showSpinner();
      try {
        await push(ref(db, "courses"), {
          providerId: auth.currentUser.uid,
          name,
          metadata: { tags, version: "1.0" },
          enrolled: [],
          completions: [],
          archived: false,
          createdAt: Date.now()
        });
        logAudit(`Added course ${name}`);
        dom.courseForm.reset();
      } catch (err) {
        console.error("Error adding course:", err);
        showError(`Failed to add course: ${err.message}`);
      }
      hideSpinner();
    });

    window.editCourse = async courseId => {
      const c = courses[courseId];
      const newName = prompt("Edit course name:", c.name);
      const newTags = prompt("Edit tags (comma-separated):", c.metadata?.tags?.join(", ") || "");
      if (newName && newTags) {
        if (!validateTags(newTags)) return showError("Each tag must be 50 characters or less.");
        showSpinner();
        try {
          await update(ref(db, `courses/${courseId}`), {
            name: sanitizeInput(newName),
            metadata: { tags: newTags.split(",").map(t => sanitizeInput(t.trim())), version: "1.1" }
          });
          logAudit(`Edited course ${newName}`);
        } catch (err) {
          console.error("Error editing course:", err);
          showError(`Failed to edit course: ${err.message}`);
        }
        hideSpinner();
      }
    };

    window.archiveCourse = async courseId => {
      showSpinner();
      try {
        await update(ref(db, `courses/${courseId}`), { archived: !courses[courseId].archived });
        logAudit(`Course ${courses[courseId].name} ${courses[courseId].archived ? "unarchived" : "archived"}`);
      } catch (err) {
        console.error("Error archiving course:", err);
        showError(`Failed to archive course: ${err.message}`);
      }
      hideSpinner();
    };

    // Learner Progress
    function loadLearnerProgress() {
      showSpinner();
      onValue(ref(db, "users"), snap => {
        learners = snap.val() || {};
        onValue(ref(db, "courses"), snap => {
          courses = snap.val() || {};
          onValue(ref(db, "assessments"), snap => {
            assessments = snap.val() || {};
            onValue(ref(db, "certifications"), snap => {
              certifications = snap.val() || {};
              renderLearnerProgress();
              hideSpinner();
            });
          });
        });
      });
    }

    function renderLearnerProgress(filter = "") {
      dom.progressList.innerHTML = "";
      for (const id in learners) {
        const l = learners[id];
        if (l.role !== "learner" || l.providerId !== auth.currentUser.uid) continue;
        if (filter && !l.fullName?.toLowerCase().includes(filter.toLowerCase()) && !l.email.toLowerCase().includes(filter.toLowerCase())) continue;
        const enrolledCourses = Object.values(courses).filter(c => c.providerId === auth.currentUser.uid && c.enrolled?.includes(id));
        if (enrolledCourses.length === 0) continue;
        const learnerItem = document.createElement("div");
        learnerItem.className = "bg-gray-50 p-4 rounded shadow hover:shadow-md transition-shadow";
        let courseDetails = "";
        enrolledCourses.forEach(c => {
          const cert = Object.values(certifications).find(cert => cert.learnerId === id && cert.courseId === c.id);
          const completedAssessments = Object.values(assessments).filter(a => a.courseId === c.id && a.submissions?.[id]?.status === "completed").length;
          const totalAssessments = Object.values(assessments).filter(a => a.courseId === c.id).length;
          const progress = l.progress?.[c.id] || 0;
          if (progress >= 50 && !notifications.some(n => n.learnerId === id && n.courseId === c.id && n.message.includes("50%"))) {
            notifications.push({ learnerId: id, courseId: c.id, message: `${l.fullName || l.email} reached 50% progress in ${c.name}`, timestamp: Date.now() });
          }
          if (progress >= 100 && !notifications.some(n => n.learnerId === id && n.courseId === c.id && n.message.includes("completed"))) {
            notifications.push({ learnerId: id, courseId: c.id, message: `${l.fullName || l.email} completed ${c.name}`, timestamp: Date.now() });
          }
          courseDetails += `
            <p class="text-sm font-semibold">${sanitizeInput(c.name)}</p>
            <p class="text-sm text-gray-600">Progress: ${progress}% | Assessments: ${completedAssessments}/${totalAssessments} | Certificate: ${cert ? `<button onclick="downloadCertificate('${cert.id}')" class="text-blue-600 hover:underline" aria-label="Download certificate for ${sanitizeInput(c.name)}" data-tooltip="Download certificate">Download</button>` : "Not Issued"}</p>
          `;
        });
        learnerItem.innerHTML = `
          <div>
            <p class="font-semibold">${sanitizeInput(l.fullName || l.email)}</p>
            ${courseDetails}
          </div>
        `;
        dom.progressList.appendChild(learnerItem);
      }
    }

    const searchProgress = debounce(filter => renderLearnerProgress(sanitizeInput(filter)), 300);
    dom.progressSearch.addEventListener("input", () => searchProgress(dom.progressSearch.value));

    window.downloadCertificate = certId => {
      const cert = certifications[certId];
      if (!cert || !courses[cert.courseId] || !learners[cert.learnerId]) {
        showError("Certificate, course, or learner data not found.");
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(20);
      doc.text("Certificate of Completion", 105, 30, { align: "center" });
      doc.setFontSize(16);
      doc.text("This certifies that", 105, 60, { align: "center" });
      doc.setFontSize(18);
      doc.setFont("helvetica", "bold");
      doc.text(sanitizeInput(learners[cert.learnerId].fullName || learners[cert.learnerId].email), 105, 80, { align: "center" });
      doc.setFont("helvetica", "normal");
      doc.setFontSize(16);
      doc.text("has successfully completed the course", 105, 100, { align: "center" });
      doc.setFontSize(18);
      doc.setFont("helvetica", "bold");
      doc.text(sanitizeInput(courses[cert.courseId].name), 105, 120, { align: "center" });
      doc.setFont("helvetica", "normal");
      doc.setFontSize(14);
      doc.text(`Issued on: ${new Date(cert.issuedAt).toLocaleDateString()}`, 105, 140, { align: "center" });
      doc.text("CETA Provider Academy", 105, 160, { align: "center" });
      doc.save(`certificate_${certId}.pdf`);
      logAudit(`Downloaded certificate for ${learners[cert.learnerId].fullName || learners[cert.learnerId].email}`);
    };

    // Analytics
    function loadAnalytics() {
      showSpinner();
      onValue(ref(db, "courses"), snap => {
        courses = snap.val() || {};
        onValue(ref(db, "assessments"), snap => {
          assessments = snap.val() || {};
          onValue(ref(db, "certifications"), snap => {
            certifications = snap.val() || {};
            renderAnalytics();
            hideSpinner();
          });
        });
      });
    }

    function predictCompletionRate(courseId) {
      const course = courses[courseId];
      if (!course || !course.enrolled) return 0;
      const completions = course.completions?.length || 0;
      const enrolled = course.enrolled.length;
      const historicalRate = enrolled > 0 ? completions / enrolled : 0;
      const difficultyFactor = course.metadata?.tags?.includes("advanced") ? 0.8 : 1;
      const engagementFactor = course.enrolled.length > 10 ? 1.1 : 0.9;
      const predictedRate = historicalRate * difficultyFactor * engagementFactor * 100;
      return Math.min(Math.max(predictedRate.toFixed(1), 0), 100);
    }

    function calculateStatisticalMetrics(courseId) {
      const course = courses[courseId];
      const assessmentsForCourse = Object.values(assessments).filter(a => a.courseId === courseId);
      const completionTimes = [];
      const scores = [];

      assessmentsForCourse.forEach(a => {
        if (a.submissions) {
          Object.values(a.submissions).forEach(s => {
            if (s.status === "completed" && s.completedAt && s.submittedAt) {
              completionTimes.push((s.completedAt - s.submittedAt) / (1000 * 60 * 60));
            }
            if (s.score) scores.push(s.score);
          });
        }
      });

      const avgCompletionTime = completionTimes.length > 0 ? (completionTimes.reduce((a, b) => a + b, 0) / completionTimes.length).toFixed(1) : 0;
      const avgScore = scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1) : 0;
      const stdDevScore = scores.length > 0 ? Math.sqrt(scores.reduce((a, b) => a + Math.pow(b - avgScore, 2), 0) / scores.length).toFixed(1) : 0;
      const difficultyIndex = scores.length > 0 ? (100 - avgScore).toFixed(1) : 0;

      return { avgCompletionTime, avgScore, stdDevScore, difficultyIndex };
    }

    function generateHeatmapData() {
      const heatmapData = Array(7).fill().map(() => Array(24).fill(0));
      for (const id in assessments) {
        const submissions = assessments[id].submissions || {};
        for (const subId in submissions) {
          const submission = submissions[subId];
          if (submission.submittedAt && courses[assessments[id].courseId]?.providerId === auth.currentUser.uid) {
            const date = new Date(submission.submittedAt);
            const day = date.getDay();
            const hour = date.getHours();
            heatmapData[day][hour]++;
          }
        }
      }
      return heatmapData;
    }

    function renderAnalytics() {
      dom.analyticsDetails.innerHTML = "";
      const timeRangeValue = dom.timeRange.value;
      const courseFilterValue = dom.courseFilter.value;
      const groupFilterValue = dom.groupFilterAnalytics.value;
      const chartTypeValue = dom.chartType.value;
      const now = Date.now();
      let cutoff = 0;
      if (timeRangeValue === "30") cutoff = now - 30 * 24 * 60 * 60 * 1000;
      else if (timeRangeValue === "90") cutoff = now - 90 * 24 * 60 * 60 * 1000;
      else if (timeRangeValue === "365") cutoff = now - 365 * 24 * 60 * 60 * 1000;

      const chartData = {
        labels: [],
        datasets: [
          { label: "Completion Rate (%)", data: [], backgroundColor: "#2563eb", stack: "Stack 0", fill: chartTypeValue === "line" },
          { label: "Average Assessment Score (%)", data: [], backgroundColor: "#10b981", stack: "Stack 0", fill: chartTypeValue === "line" },
          { label: "Predicted Completion Rate (%)", data: [], backgroundColor: "#f59e0b", stack: "Stack 0", fill: chartTypeValue === "line" }
        ]
      };

      const filteredCourses = Object.entries(courses).filter(([id, c]) => {
        if (c.providerId !== auth.currentUser.uid || c.archived) return false;
        if (courseFilterValue && courseFilterValue !== id) return false;
        if (cutoff && c.createdAt < cutoff) return false;
        return true;
      });

      const analyticsData = [];
      filteredCourses.forEach(([id, c]) => {
        let filteredLearners = Object.keys(learners).filter(lid => learners[lid].role === "learner" && learners[lid].providerId === auth.currentUser.uid && c.enrolled?.includes(lid));
        if (groupFilterValue) filteredLearners = filteredLearners.filter(lid => learners[lid].metadata?.tags?.includes(groupFilterValue));
        const completionRate = filteredLearners.length > 0 ? (c.completions?.filter(lid => filteredLearners.includes(lid)).length || 0) / filteredLearners.length * 100 : 0;
        let totalScore = 0, scoreCount = 0;
        const assessmentsForCourse = Object.values(assessments).filter(a => a.courseId === id && (!cutoff || a.createdAt >= cutoff));
        assessmentsForCourse.forEach(a => {
          for (const subId in a.submissions) {
            if (filteredLearners.includes(subId) && (!cutoff || a.submissions[subId].submittedAt >= cutoff)) {
              if (a.submissions[subId].score) {
                totalScore += a.submissions[subId].score;
                scoreCount++;
              }
            }
          }
        });
        const avgScore = scoreCount > 0 ? (totalScore / scoreCount).toFixed(1) : 0;
        const predictedRate = predictCompletionRate(id);
        const stats = calculateStatisticalMetrics(id);

        chartData.labels.push(c.name);
        chartData.datasets[0].data.push(completionRate.toFixed(1));
        chartData.datasets[1].data.push(avgScore);
        chartData.datasets[2].data.push(predictedRate);

        analyticsData.push({
          courseId: id,
          name: c.name,
          completionRate: completionRate.toFixed(1),
          avgScore,
          predictedRate,
          ...stats
        });

        const detailItem = document.createElement("div");
        detailItem.className = "bg-gray-50 p-4 rounded shadow hover:shadow-md transition-shadow";
        detailItem.innerHTML = `
          <p class="font-semibold">${sanitizeInput(c.name)}</p>
          <p class="text-sm text-gray-600">Enrolled: ${filteredLearners.length} | Completion Rate: ${completionRate.toFixed(1)}% | Predicted Completion: ${predictedRate}%</p>
          <p class="text-sm text-gray-600">Avg Score: ${avgScore}% | Avg Completion Time: ${stats.avgCompletionTime} hrs | Score Std Dev: ${stats.stdDevScore} | Difficulty Index: ${stats.difficultyIndex}</p>
        `;
        dom.analyticsDetails.appendChild(detailItem);
      });

      if (analyticsChartInstance) analyticsChartInstance.destroy();
      analyticsChartInstance = new Chart(dom.analyticsChart, {
        type: chartTypeValue,
        data: chartData,
        options: {
          scales: {
            y: { beginAtZero: true, max: 100 },
            x: { stacked: chartTypeValue === "bar" }
          },
          plugins: {
            tooltip: { mode: "index", intersect: false },
            datalabels: { anchor: "end", align: "top", color: "#374151", font: { weight: "bold" } }
          }
        },
        plugins: [ChartDataLabels]
      });

      const heatmapData = generateHeatmapData();
      if (heatmapChartInstance) heatmapChartInstance.destroy();
      heatmapChartInstance = new Chart(dom.heatmapChart, {
        type: "matrix",
        data: {
          datasets: [{
            label: "Submission Activity",
            data: heatmapData.flatMap((row, day) => row.map((value, hour) => ({ x: hour, y: day, v: value }))),
            backgroundColor: c => {
              const value = c.raw.v;
              const alpha = Math.min(value / 10, 1);
              return `rgba(37, 99, 235, ${alpha})`;
            },
            width: ({ chart }) => (chart.chartArea?.width || 0) / 24,
            height: ({ chart }) => (chart.chartArea?.height || 0) / 7
          }]
        },
        options: {
          scales: {
            x: { type: "category", labels: Array.from({ length: 24 }, (_, i) => `${i}:00`), title: { display: true, text: "Hour of Day" } },
            y: { type: "category", labels: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"], title: { display: true, text: "Day of Week" } }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => `Submissions: ${ctx.raw.v} at ${ctx.raw.x}:00 on ${ctx.chart.scales.y.getLabelForValue(ctx.raw.y)}`
              }
            }
          }
        }
      });
    }

    dom.exportAnalytics.addEventListener("click", () => {
      const timeRangeValue = dom.timeRange.value;
      const courseFilterValue = dom.courseFilter.value;
      const groupFilterValue = dom.groupFilterAnalytics.value;
      const now = Date.now();
      let cutoff = 0;
      if (timeRangeValue === "30") cutoff = now - 30 * 24 * 60 * 60 * 1000;
      else if (timeRangeValue === "90") cutoff = now - 90 * 24 * 60 * 60 * 1000;
      else if (timeRangeValue === "365") cutoff = now - 365 * 24 * 60 * 60 * 1000;

      const filteredCourses = Object.entries(courses).filter(([id, c]) => {
        if (c.providerId !== auth.currentUser.uid || c.archived) return false;
        if (courseFilterValue && courseFilterValue !== id) return false;
        if (cutoff && c.createdAt < cutoff) return false;
        return true;
      });

      const docDefinition = {
        content: [
          { text: "CETA Provider Analytics Report", style: "header" },
          { text: `Generated on ${new Date().toLocaleDateString()}`, style: "subheader" },
          { text: `Time Range: ${timeRangeValue === "all" ? "All Time" : `Last ${timeRangeValue} Days`}`, style: "subheader" },
          { text: courseFilterValue ? `Course: ${courses[courseFilterValue]?.name || "All"}` : "All Courses", style: "subheader" },
          { text: groupFilterValue ? `Group: ${groupFilterValue}` : "All Groups", style: "subheader" },
          {
            table: {
              headerRows: 1,
              widths: ["*", "*", "*", "*", "*", "*"],
              body: [
                ["Course", "Enrolled", "Completion Rate (%)", "Avg Score (%)", "Predicted Completion (%)", "Difficulty Index"],
                ...filteredCourses.map(([id, c]) => {
                  let filteredLearners = Object.keys(learners).filter(lid => learners[lid].role === "learner" && learners[lid].providerId === auth.currentUser.uid && c.enrolled?.includes(lid));
                  if (groupFilterValue) filteredLearners = filteredLearners.filter(lid => learners[lid].metadata?.tags?.includes(groupFilterValue));
                  const stats = calculateStatisticalMetrics(id);
                  const completionRate = filteredLearners.length > 0 ? (c.completions?.filter(lid => filteredLearners.includes(lid)).length || 0) / filteredLearners.length * 100 : 0;
                  let totalScore = 0, scoreCount = 0;
                  Object.values(assessments)
                    .filter(a => a.courseId === id && (!cutoff || a.createdAt >= cutoff))
                    .forEach(a => {
                      for (const subId in a.submissions) {
                        if (filteredLearners.includes(subId) && (!cutoff || a.submissions[subId].submittedAt >= cutoff)) {
                          if (a.submissions[subId].score) {
                            totalScore += a.submissions[subId].score;
                            scoreCount++;
                          }
                        }
                      }
                    });
                  const avgScore = scoreCount > 0 ? (totalScore / scoreCount).toFixed(1) : 0;
                  return [
                    sanitizeInput(c.name),
                    filteredLearners.length,
                    completionRate.toFixed(1),
                    avgScore,
                    predictCompletionRate(id),
                    stats.difficultyIndex
                  ];
                })
              ]
            }
          },
          { text: "Statistical Metrics", style: "subheader", margin: [0, 20, 0, 10] },
          {
            ul: filteredCourses.map(([id, c]) => {
              const stats = calculateStatisticalMetrics(id);
              return `${sanitizeInput(c.name)}: Avg Completion Time: ${stats.avgCompletionTime} hrs, Score Std Dev: ${stats.stdDevScore}`;
            })
          }
        ],
        styles: {
          header: { fontSize: 18, bold: true, margin: [0, 0, 0, 10] },
          subheader: { fontSize: 14, margin: [0, 0, 0, 10] }
        }
      };

      pdfMake.createPdf(docDefinition).download(`analytics_report_${new Date().toISOString().split("T")[0]}.pdf`);
    });

    // Helpdesk
    function loadTickets() {
      showSpinner();
      onValue(ref(db, "helpdesk"), snap => {
        tickets = snap.val() || {};
        onValue(ref(db, "users"), snap => {
          learners = snap.val() || {};
          dom.ticketList.inner
            renderTickets();
          hideSpinner();
        });
      });
    }

    function renderTickets(filter = "", page = 1) {
      dom.ticketList.innerHTML = "";
      const filteredTickets = Object.entries(tickets).filter(([id, t]) => {
        if (t.providerId !== auth.currentUser.uid) return false;
        if (filter && !t.subject?.toLowerCase().includes(filter.toLowerCase()) && !t.description?.toLowerCase().includes(filter.toLowerCase()) && !learners[t.learnerId]?.fullName?.toLowerCase().includes(filter.toLowerCase())) return false;
        return true;
      });

      const totalPages = Math.ceil(filteredTickets.length / itemsPerPage);
      const start = (page - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const paginatedTickets = filteredTickets.slice(start, end);

      paginatedTickets.forEach(([id, t]) => {
        const learner = learners[t.learnerId] || { fullName: "Unknown", email: "Unknown" };
        const ticketItem = document.createElement("div");
        ticketItem.className = "bg-gray-50 p-4 rounded shadow hover:shadow-md transition-shadow";
        ticketItem.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <p class="font-semibold">${sanitizeInput(t.subject)}</p>
              <p class="text-sm text-gray-600">From: ${sanitizeInput(learner.fullName || learner.email)}</p>
              <p class="text-sm text-gray-600">Status: ${sanitizeInput(t.status)} | Priority: ${sanitizeInput(t.priority || "Medium")}</p>
              <p class="text-sm text-gray-600">Created: ${new Date(t.createdAt).toLocaleString()}</p>
              <p class="text-sm text-gray-600">${sanitizeInput(t.description)}</p>
              ${t.responses ? `
                <div class="mt-2">
                  <h4 class="text-sm font-semibold">Responses:</h4>
                  <ul class="text-sm text-gray-600 space-y-1">
                    ${t.responses.map(r => `<li>${sanitizeInput(r.message)} (${new Date(r.timestamp).toLocaleString()} by ${sanitizeInput(r.author)})</li>`).join("")}
                  </ul>
                </div>
              ` : ""}
            </div>
            <div class="flex gap-2">
              <button onclick="respondToTicket('${id}')" class="text-blue-600 hover:underline" aria-label="Respond to ticket ${sanitizeInput(t.subject)}" data-tooltip="Respond">Respond</button>
              <button onclick="updateTicketStatus('${id}', 'resolved')" class="text-green-600 hover:underline" aria-label="Resolve ticket ${sanitizeInput(t.subject)}" data-tooltip="Resolve">${t.status === "resolved" ? "Reopen" : "Resolve"}</button>
            </div>
          </div>
        `;
        dom.ticketList.appendChild(ticketItem);
      });

      renderPagination(dom.ticketPagination, page, totalPages, newPage => {
        renderTickets(filter, newPage);
      });
    }

    const searchTickets = debounce(filter => renderTickets(sanitizeInput(filter)), 300);
    dom.ticketSearch = document.createElement("input");
    dom.ticketSearch.type = "text";
    dom.ticketSearch.placeholder = "Search tickets...";
    dom.ticketSearch.className = "border p-2 rounded w-full mb-4";
    dom.ticketSearch.setAttribute("aria-label", "Search tickets by subject, description, or learner name");
    dom.ticketList.insertAdjacentElement("beforebegin", dom.ticketSearch);
    dom.ticketSearch.addEventListener("input", () => searchTickets(dom.ticketSearch.value));

    window.respondToTicket = async ticketId => {
      const ticket = tickets[ticketId];
      if (!ticket) return showError("Ticket not found.");

      const modal = document.createElement("div");
      modal.className = "modal";
      modal.style.display = "block";
      modal.innerHTML = `
        <div class="modal-content">
          <h3 class="text-lg font-semibold mb-4">Respond to Ticket: ${sanitizeInput(ticket.subject)}</h3>
          <form id="ticket-response-form">
            <textarea id="ticketResponse" placeholder="Enter your response" class="border p-2 rounded w-full mb-2" aria-label="Enter response to ticket" required></textarea>
            <select id="ticketPriority" class="border p-2 rounded w-full mb-2" aria-label="Select ticket priority">
              <option value="Low">Low</option>
              <option value="Medium" selected>Medium</option>
              <option value="High">High</option>
            </select>
            <div class="flex gap-2">
              <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" data-tooltip="Submit response">Submit</button>
              <button type="button" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700" onclick="this.closest('.modal').remove()" data-tooltip="Cancel">Cancel</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);

      const form = modal.querySelector("#ticket-response-form");
      form.addEventListener("submit", async e => {
        e.preventDefault();
        const response = sanitizeInput(modal.querySelector("#ticketResponse").value.trim());
        const priority = modal.querySelector("#ticketPriority").value;

        if (!response) return showError("Response cannot be empty.");

        showSpinner();
        try {
          await runTransaction(ref(db, `helpdesk/${ticketId}`), ticket => {
            ticket = ticket || {};
            ticket.responses = ticket.responses || [];
            ticket.responses.push({
              message: response,
              author: user.fullName || user.email,
              timestamp: Date.now()
            });
            ticket.priority = priority;
            ticket.updatedAt = Date.now();
            return ticket;
          });
          logAudit(`Responded to ticket ${ticket.subject} with priority ${priority}`);
          modal.remove();
        } catch (err) {
          console.error("Error responding to ticket:", err);
          showError(`Failed to respond to ticket: ${err.message}`);
        }
        hideSpinner();
      });
    };

    window.updateTicketStatus = async (ticketId, status) => {
      if (!tickets[ticketId]) return showError("Ticket not found.");
      showSpinner();
      try {
        await update(ref(db, `helpdesk/${ticketId}`), { status, updatedAt: Date.now() });
        logAudit(`Updated ticket ${tickets[ticketId].subject} to status ${status}`);
      } catch (err) {
        console.error("Error updating ticket status:", err);
        showError(`Failed to update ticket status: ${err.message}`);
      }
      hideSpinner();
    };

    function populateCourseFilter() {
      dom.courseFilter.innerHTML = '<option value="">All Courses</option>';
      for (const id in courses) {
        if (courses[id].providerId === auth.currentUser.uid && !courses[id].archived) {
          const option = document.createElement("option");
          option.value = id;
          option.textContent = sanitizeInput(courses[id].name);
          dom.courseFilter.appendChild(option);
        }
      }
    }

    function logAudit(message) {
      push(ref(db, `auditLogs/${auth.currentUser.uid}`), {
        message,
        timestamp: Date.now(),
        userId: auth.currentUser.uid,
        userEmail: user.email
      }).catch(err => console.error("Audit log error:", err));
    }

    // Initialize
    function init() {
      setupUIEvents();
      checkAuth();
    }

    init();
  </script>
</body>
</html>
