<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CETA Provider Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <style>
    /* Root variables for consistent theming */
    :root {
      --primary: #1e40af; /* Blue for buttons and accents */
      --secondary: #10b981; /* Green for success actions */
      --background: #f3f4f6; /* Light gray background */
      --card-bg: #ffffff; /* White for cards */
      --text-primary: #1f2937; /* Dark gray for text */
      --text-secondary: #6b7280; /* Lighter gray for secondary text */
      --high-contrast-bg: #1a1a1a; /* Dark background for high contrast */
      --high-contrast-text: #e5e5e5; /* Light text for high contrast */
    }

    /* Base styles */
    body {
      background: var(--background);
      color: var(--text-primary);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: linear-gradient(to bottom, #111827, #1f2937);
      color: white;
      min-height: 100vh;
      padding: 1.5rem;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, width 0.3s ease;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 50;
    }

    .sidebar-hidden {
      transform: translateX(-100%);
      width: 0;
    }

    .sidebar-open {
      transform: translateX(0);
    }

    .sidebar .nav-button {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      border-radius: 0.375rem;
      transition: background-color 0.2s ease;
    }

    .sidebar .nav-button:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .sidebar .nav-button.active {
      background: var(--primary);
    }

    /* Main content */
    .main-content {
      flex: 1;
      margin-left: 260px;
      padding: 2rem;
      transition: margin-left 0.3s ease;
      min-height: 100vh;
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 260px;
        transform: translateX(-100%);
      }
      .sidebar-open {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
      }
    }

    /* Cards */
    .card {
      background: var(--card-bg);
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    /* High contrast mode */
    .high-contrast {
      background: #000 !important;
      color: var(--high-contrast-text) !important;
    }

    .high-contrast .card {
      background: var(--high-contrast-bg) !important;
    }

    .high-contrast .text-gray-600 {
      color: var(--high-contrast-text) !important;
    }

    .high-contrast .bg-gray-50 {
      background: #2d3748 !important;
    }

    /* Tooltip */
    .tooltip {
      position: relative;
    }

    .tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #1f2937;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      white-space: nowrap;
      z-index: 10;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--card-bg);
      margin: 0 auto;
      padding: 1.5rem;
      width: 90%;
      max-width: 600px;
      border-radius: 0.5rem;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }

    .high-contrast .modal-content {
      background: var(--high-contrast-bg) !important;
      color: var(--high-contrast-text) !important;
    }

    /* Video feed */
    .video-feed {
      background: black;
      border-radius: 0.5rem;
      overflow: hidden;
      position: relative;
      aspect-ratio: 16 / 9;
    }

    .video-label {
      position: absolute;
      top: 0.5rem;
      left: 0.5rem;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.875rem;
    }

    /* Buttons */
    button:not(.nav-button) {
      transition: background-color 0.2s ease, transform 0.2s ease;
    }

    button:hover:not(.nav-button) {
      transform: translateY(-1px);
    }

    /* Form elements */
    input, select, textarea {
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.2);
    }

    /* Loading spinner */
    #loading-spinner {
      z-index: 200;
    }

    /* Ensure charts fit */
    canvas {
      max-width: 100%;
      height: auto !important;
    }

    /* Scrollable sections */
    .section {
      max-height: calc(100vh - 4rem);
      overflow-y: auto;
      padding-right: 0.5rem;
    }

    .section::-webkit-scrollbar {
      width: 8px;
    }

    .section::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }

    .section::-webkit-scrollbar-track {
      background: #e5e7eb;
    }
  </style>
</head>
<body>
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <div id="sidebar" class="sidebar">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-xl font-bold flex items-center gap-2">
          <i class="fas fa-graduation-cap"></i> CETA Provider
        </h1>
        <button id="toggle-sidebar" class="md:hidden text-white focus:outline-none" aria-label="Toggle sidebar">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
      <nav>
        <ul class="space-y-2">
          <li><button class="nav-button w-full text-left" data-section="overview" data-tooltip="Dashboard Overview"><i class="fas fa-tachometer-alt"></i> Overview</button></li>
          <li><button class="nav-button w-full text-left" data-section="learners" data-tooltip="Manage Learners"><i class="fas fa-users"></i> Manage Learners</button></li>
          <li><button class="nav-button w-full text-left" data-section="courses" data-tooltip="Manage Courses"><i class="fas fa-book"></i> Manage Courses</button></li>
          <li><button class="nav-button w-full text-left" data-section="progress" data-tooltip="Learner Progress"><i class="fas fa-chart-line"></i> Learner Progress</button></li>
          <li><button class="nav-button w-full text-left" data-section="analytics" data-tooltip="Advanced Analytics"><i class="fas fa-chart-bar"></i> Analytics</button></li>
          <li><button class="nav-button w-full text-left" data-section="helpdesk" data-tooltip="Support Tickets"><i class="fas fa-headset"></i> Helpdesk</button></li>
          <li><button class="nav-button w-full text-left" data-section="video-monitoring" data-tooltip="Live Video Monitoring"><i class="fas fa-video"></i> Video Monitoring</button></li>
          <li><button class="nav-button w-full text-left" data-section="content" data-tooltip="Manage Course Content"><i class="fas fa-file-alt"></i> Course Content</button></li>
          <li><button class="nav-button w-full text-left" data-section="assignments" data-tooltip="Manage Assignments"><i class="fas fa-tasks"></i> Assignments</button></li>
          <li><button class="nav-button w-full text-left" data-section="forums" data-tooltip="Course Forums"><i class="fas fa-comments"></i> Forums</button></li>
          <li><button class="nav-button w-full text-left" data-section="quizzes" data-tooltip="Manage Quizzes"><i class="fas fa-question-circle"></i> Quizzes</button></li>
        </ul>
      </nav>
      <div class="mt-auto">
        <button id="toggle-contrast" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded mb-2" aria-label="Toggle high contrast mode" data-tooltip="Toggle High Contrast">Toggle High Contrast</button>
        <button id="signout-btn" class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded" aria-label="Sign out of provider account" data-tooltip="Sign Out">Sign Out</button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Overview Section -->
      <div id="overview" class="section">
        <h2 class="text-2xl font-semibold mb-4">Welcome, <span id="provider-name">Provider</span></h2>
        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
          <div class="card">
            <h3 class="text-lg font-semibold">Courses Offered</h3>
            <p id="courses-offered" class="text-3xl font-bold text-blue-600">0</p>
          </div>
          <div class="card">
            <h3 class="text-lg font-semibold">Enrolled Learners</h3>
            <p id="enrolled-learners" class="text-3xl font-bold text-blue-600">0</p>
          </div>
          <div class="card">
            <h3 class="text-lg font-semibold">Completion Rate</h3>
            <p id="completion-rate" class="text-3xl font-bold text-blue-600">0%</p>
          </div>
          <div class="card">
            <h3 class="text-lg font-semibold">Certificates Issued</h3>
            <p id="certificates-issued" class="text-3xl font-bold text-blue-600">0</p>
          </div>
        </div>
        <div class="mt-6 card">
          <h3 class="text-lg font-semibold mb-2">Course Completion Rates</h3>
          <canvas id="completion-chart"></canvas>
        </div>
        <div class="mt-6 card">
          <h3 class="text-lg font-semibold mb-2">Enrollment Trends</h3>
          <canvas id="enrollment-trend-chart"></canvas>
        </div>
      </div>

      <!-- Learners Section -->
      <div id="learners" class="section hidden">
        <h2 class="text-2xl font-semibold mb-4">Manage Learners</h2>
        <div class="mb-4 card">
          <h3 class="text-lg font-semibold mb-2">Add New Learner</h3>
          <button id="open-add-learner" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded" data-tooltip="Add new learner">Add Learner</button>
          <button id="open-bulk-upload" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded ml-2" data-tooltip="Upload learners via CSV">Bulk Upload</button>
        </div>
        <div class="card">
          <h3 class="text-lg font-semibold mb-2">Learner List</h3>
          <input type="text" id="learnerSearch" placeholder="Search learners..." class="border p-2 rounded w-full mb-4" aria-label="Search learners by name, email, or tag" />
          <select id="groupFilter" class="border p-2 rounded mb-4 w-full md:w-auto" aria-label="Filter by group">
            <option value="">All Groups</option>
          </select>
          <div id="learnerList" class="space-y-4"></div>
        </div>
      </div>

      <!-- Courses Section -->
      <div id="courses" class="section hidden">
        <h2 class="text-2xl font-semibold mb-4">Manage Courses</h2>
        <div class="mb-4 card">
          <h3 class="text-lg font-semibold mb-2">Add New Course</h3>
          <form id="course-form">
            <input type="text" id="courseName" placeholder="Course Name" class="border p-2 rounded w-full mb-2" aria-label="Enter course name" required />
            <input type="text" id="courseTags" placeholder="Tags (comma-separated)" class="border p-2 rounded w-full mb-2" aria-label="Enter course tags" />
            <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded" data-tooltip="Add new course">Add Course</button>
          </form>
        </div>
        <div class="card">
          <h3 class="text-lg font-semibold mb-2">Course List</h3>
          <input type="text" id="courseSearch" placeholder="Search courses..." class="border p-2 rounded w-full mb-4" aria-label="Search courses by name or tag" />
          <div id="courseList" class="space-y-4"></div>
        </div>
      </div>

      <!-- Course Content Section -->
      <div id="content" class="section hidden">
        <h2 class="text-2xl font-semibold mb-4">Manage Course Content</h2>
        <div class="mb-4 card">
          <h3 class="text-lg font-semibold mb-2">Upload Content</h3>
          <form id="content-upload-form">
            <select id="contentCourse" class="border p-2 rounded w-full mb-2" aria-label="Select course" required>
              <option value="">Select Course</option>
            </select>
            <input type="text" id="contentTitle" placeholder="Content Title" class="border p-2 rounded w-full mb-2" aria-label="Enter content title" required />
            <select id="contentType" class="border p-2 rounded w-full mb-2" aria-label="Select content type" required>
              <option value="video">Video</option>
              <option value="pdf">PDF</option>
              <option value="text">Text</option>
            </select>
            <input type="file" id="contentFile" accept="video/*,application/pdf,.txt" class="border p-2 rounded w-full mb-2" aria-label="Upload content file" required />
            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded" data-tooltip="Upload content">Upload</button>
          </form>
        </div>
        <div class="card">
          <h3 class="text-lg font-semibold mb-2">Content List</h3>
          <input type="text" id="contentSearch" placeholder="Search content..." class="border p-2 rounded w-full mb-4" aria-label="Search content by title" />
          <select id="contentCourseFilter" class="border p-2 rounded mb-4 w-full md:w-auto" aria-label="Filter by course">
            <option value="">All Courses</option>
          </select>
          <div id="contentList" class="space-y-4"></div>
        </div>
      </div>

      <!-- Assignments Section -->
      <div id="assignments" class="section hidden">
        <h2 class="text-2xl font-semibold mb-4">Manage Assignments</h2>
        <div class="mb-4 card">
          <h3 class="text-lg font-semibold mb-2">Create Assignment</h3>
          <form id="assignment-form">
            <select id="assignmentCourse" class="border p-2 rounded w-full mb-2" aria-label="Select course" required>
              <option value="">Select Course</option>
            </select>
            <input type="text" id="assignmentTitle" placeholder="Assignment Title" class="border p-2 rounded w-full mb-2" aria-label="Enter assignment title" required />
            <textarea id="assignmentDescription" placeholder="Description" class="border p-2 rounded w-full mb-2" aria-label="Enter assignment description" required></textarea>
            <input type="date" id="assignmentDueDate" class="border p-2 rounded w-full mb-2" aria-label="Select due date" required />
            <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded" data-tooltip="Create assignment">Create</button>
          </form>
        </div>
        <div class="card">
          <h3 class="text-lg font-semibold mb-2">Assignment Submissions</h3>
          <input type="text" id="assignmentSearch" placeholder="Search assignments..." class="border p-2 rounded w-full mb-4" aria-label="Search assignments by title or learner" />
          <select id="assignmentCourseFilter" class="border p-2 rounded mb-4 w-full md:w-auto" aria-label="Filter by course">
            <option value="">All Courses</option>
          </select>
          <div id="assignmentList" class="space-y-4"></div>
        </div>
      </div>

      <!-- Forums Section -->
      <div id="forums" class="section hidden">
        <h2 class="text-2xl font-semibold mb-4">Course Forums</h2>
        <div class="mb-4 card">
          <h3 class="text-lg font-semibold mb-2">Create Forum Thread</h3>
          <form id="forum-thread-form">
            <select id="forumCourse" class="border p-2 rounded w-full mb-2" aria-label="Select course" required>
              <option value="">Select Course</option>
            </select>
            <input type="text" id="threadTitle" placeholder="Thread Title" class="border p-2 rounded w-full mb-2" aria-label="Enter thread title" required />
            <textarea id="threadContent" placeholder="Initial Post Content" class="border p-2 rounded w-full mb-2" aria-label="Enter initial post content" required></textarea>
            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded" data-tooltip="Create thread">Create Thread</button>
          </form>
        </div>
        <div class="card">
          <h3 class="text-lg font-semibold mb-2">Forum Threads</h3>
          <input type="text" id="forumSearch" placeholder="Search threads..." class="border p-2 rounded w-full mb-4" aria-label="Search threads by title" />
          <select id="forumCourseFilter" class="border p-2 rounded mb-4 w-full md:w-auto" aria-label="Filter by course">
            <option value="">All Courses</option>
          </select>
          <div id="forumList" class="space-y-4"></div>
        </div>
      </div>

      <!-- Quizzes Section -->
      <div id="quizzes" class="section hidden">
        <h2 class="text-2xl font-semibold mb-4">Manage Quizzes</h2>
        <div class="mb-4 card">
          <h3 class="text-lg font-semibold mb-2">Create Quiz</h3>
          <form id="quiz-form">
            <select id="quizCourse" class="border p-2 rounded w-full mb-2" aria-label="Select course" required>
              <option value="">Select Course</option>
            </select>
            <input type="text" id="quizTitle" placeholder="Quiz Title" class="border p-2 rounded w-full mb-2" aria-label="Enter quiz title" required />
            <div id="quizQuestions" class="space-y-2"></div>
            <button type="button" id="add-quiz-question" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded mt-2" data-tooltip="Add question">Add Question</button>
            <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded mt-2" data-tooltip="Create quiz">Create Quiz</button>
          </form>
        </div>
        <div class="card">
          <h3 class="text-lg font-semibold mb-2">Quiz List</h3>
          <input type="text" id="quizSearch" placeholder="Search quizzes..." class="border p-2 rounded w-full mb-4" aria-label="Search quizzes by title" />
          <select id="quizCourseFilter" class="border p-2 rounded mb-4 w-full md:w-auto" aria-label="Filter by course">
            <option value="">All Courses</option>
          </select>
          <div id="quizList" class="space-y-4"></div>
        </div>
      </div>

      <!-- Learner Progress Section -->
      <div id="progress" class="section hidden">
        <h2 class="text-2xl font-semibold mb-4">Learner Progress</h2>
        <div class="card">
          <h3 class="text-lg font-semibold mb-2">Learner Progress</h3>
          <input type="text" id="progressSearch" placeholder="Search learners..." class="border p-2 rounded w-full mb-4" aria-label="Search learners by name or email" />
          <div id="progressList" class="space-y-4"></div>
        </div>
      </div>

      <!-- Analytics Section -->
      <div id="analytics" class="section hidden">
        <h2 class="text-2xl font-semibold mb-4">Advanced Analytics</h2>
        <div class="mb-4 card">
          <h3 class="text-lg font-semibold mb-2">Filter Analytics</h3>
          <div class="flex flex-wrap gap-4 mb-4">
            <select id="timeRange" class="border p-2 rounded w-full md:w-auto" aria-label="Select time range">
              <option value="30">Last 30 Days</option>
              <option value="90">Last 90 Days</option>
              <option value="365">Last Year</option>
              <option value="all">All Time</option>
            </select>
            <select id="courseFilter" class="border p-2 rounded w-full md:w-auto" aria-label="Select course"></select>
            <select id="groupFilterAnalytics" class="border p-2 rounded w-full md:w-auto" aria-label="Select learner group">
              <option value="">All Groups</option>
            </select>
            <button id="export-analytics" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded" data-tooltip="Export analytics to PDF">Export to PDF</button>
          </div>
        </div>
        <div class="card">
          <h3 class="text-lg font-semibold mb-2">Course Performance</h3>
          <canvas id="analytics-chart"></canvas>
          <h3 class="text-lg font-semibold mt-4 mb-2">Learner Activity Heatmap</h3>
          <canvas id="heatmap-chart"></canvas>
          <h3 class="text-lg font-semibold mt-4 mb-2">Statistical Metrics</h3>
          <div id="analytics-details" class="space-y-4"></div>
        </div>
      </div>

      <!-- Helpdesk Section -->
      <div id="helpdesk" class="section hidden">
        <h2 class="text-2xl font-semibold mb-4">Helpdesk</h2>
        <div class="card">
          <h3 class="text-lg font-semibold mb-2">Support Tickets</h3>
          <div id="ticketList" class="space-y-4"></div>
        </div>
      </div>

      <!-- Video Monitoring Section -->
      <div id="video-monitoring" class="section hidden">
        <h2 class="text-2xl font-semibold mb-4">Live Video Monitoring</h2>
        <div class="card">
          <h3 class="text-lg font-semibold mb-2">Learner Video Feeds</h3>
          <input type="text" id="videoSearch" placeholder="Search learners..." class="border p-2 rounded w-full mb-4" aria-label="Search learners by name or email" />
          <select id="videoCourseFilter" class="border p-2 rounded mb-4 w-full md:w-auto" aria-label="Filter by course">
            <option value="">All Courses</option>
          </select>
          <div id="videoFeedList" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3"></div>
        </div>
      </div>

      <!-- Add Learner Modal -->
      <div id="add-learner-modal" class="modal">
        <div class="modal-content">
          <h3 class="text-lg font-semibold mb-4">Add New Learner</h3>
          <form id="add-learner-form">
            <input type="text" id="learnerFullName" placeholder="Full Name" class="border p-2 rounded w-full mb-2" aria-label="Enter learner full name" required />
            <input type="email" id="learnerEmail" placeholder="Email" class="border p-2 rounded w-full mb-2" aria-label="Enter learner email" required />
            <input type="text" id="learnerContact" placeholder="Contact Number (optional)" class="border p-2 rounded w-full mb-2" aria-label="Enter learner contact number" />
            <input type="text" id="learnerTags" placeholder="Tags (comma-separated, optional)" class="border p-2 rounded w-full mb-2" aria-label="Enter learner tags" />
            <select id="learnerCourse" class="border p-2 rounded w-full mb-2" aria-label="Select course">
              <option value="">Select Course (optional)</option>
            </select>
            <div class="flex gap-2">
              <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded" data-tooltip="Save learner">Save</button>
              <button type="button" id="close-add-learner" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded" data-tooltip="Cancel">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Bulk Upload Modal -->
      <div id="bulk-upload-modal" class="modal">
        <div class="modal-content">
          <h3 class="text-lg font-semibold mb-4">Bulk Upload Learners</h3>
          <form id="bulk-upload-form">
            <input type="file" id="learnerCSV" accept=".csv" class="border p-2 rounded w-full mb-2" aria-label="Upload CSV file" required />
            <p class="text-sm text-gray-600 mb-2">CSV format: fullName,email,contact,tags,courseId</p>
            <div class="flex gap-2">
              <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded" data-tooltip="Upload CSV">Upload</button>
              <button type="button" id="close-bulk-upload" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded" data-tooltip="Cancel">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Quiz Question Modal -->
      <div id="quiz-question-modal" class="modal">
        <div class="modal-content">
          <h3 class="text-lg font-semibold mb-4">Add Quiz Question</h3>
          <form id="quiz-question-form">
            <input type="text" id="questionText" placeholder="Question Text" class="border p-2 rounded w-full mb-2" aria-label="Enter question text" required />
            <input type="text" id="questionOptions" placeholder="Options (comma-separated)" class="border p-2 rounded w-full mb-2" aria-label="Enter question options" required />
            <input type="number" id="correctOption" placeholder="Correct Option Index (0-based)" class="border p-2 rounded w-full mb-2" aria-label="Enter correct option index" required />
            <div class="flex gap-2">
              <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded" data-tooltip="Save question">Save</button>
              <button type="button" id="close-quiz-question" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded" data-tooltip="Cancel">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <div id="loading-spinner" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-content-center">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-500"></div>
      </div>

      <noscript>
        <p class="text-red-500 text-center">JavaScript is required to use this dashboard.</p>
      </noscript>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getDatabase, ref, onValue, push, update, set, get, remove, runTransaction } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // DOM elements
    const providerName = document.getElementById("provider-name");
    const coursesOffered = document.getElementById("courses-offered");
    const enrolledLearners = document.getElementById("enrolled-learners");
    const completionRate = document.getElementById("completion-rate");
    const certificatesIssued = document.getElementById("certificates-issued");
    const courseList = document.getElementById("courseList");
    const courseSearch = document.getElementById("courseSearch");
    const learnerList = document.getElementById("learnerList");
    const learnerSearch = document.getElementById("learnerSearch");
    const groupFilter = document.getElementById("groupFilter");
    const progressList = document.getElementById("progressList");
    const progressSearch = document.getElementById("progressSearch");
    const ticketList = document.getElementById("ticketList");
    const courseForm = document.getElementById("course-form");
    const courseName = document.getElementById("courseName");
    const courseTags = document.getElementById("courseTags");
    const addLearnerModal = document.getElementById("add-learner-modal");
    const addLearnerForm = document.getElementById("add-learner-form");
    const learnerFullName = document.getElementById("learnerFullName");
    const learnerEmail = document.getElementById("learnerEmail");
    const learnerContact = document.getElementById("learnerContact");
    const learnerTags = document.getElementById("learnerTags");
    const learnerCourse = document.getElementById("learnerCourse");
    const closeAddLearner = document.getElementById("close-add-learner");
    const bulkUploadModal = document.getElementById("bulk-upload-modal");
    const bulkUploadForm = document.getElementById("bulk-upload-form");
    const learnerCSV = document.getElementById("learnerCSV");
    const closeBulkUpload = document.getElementById("close-bulk-upload");
    const completionChart = document.getElementById("completion-chart").getContext("2d");
    const enrollmentTrendChart = document.getElementById("enrollment-trend-chart").getContext("2d");
    const analyticsChart = document.getElementById("analytics-chart").getContext("2d");
    const heatmapChart = document.getElementById("heatmap-chart").getContext("2d");
    const analyticsDetails = document.getElementById("analytics-details");
    const timeRange = document.getElementById("timeRange");
    const courseFilter = document.getElementById("courseFilter");
    const groupFilterAnalytics = document.getElementById("groupFilterAnalytics");
    const exportAnalytics = document.getElementById("export-analytics");
    const loadingSpinner = document.getElementById("loading-spinner");
    const sidebar = document.getElementById("sidebar");
    const toggleSidebar = document.getElementById("toggle-sidebar");
    const toggleContrast = document.getElementById("toggle-contrast");
    const openAddLearner = document.getElementById("open-add-learner");
    const openBulkUpload = document.getElementById("open-bulk-upload");
    const contentUploadForm = document.getElementById("content-upload-form");
    const contentCourse = document.getElementById("contentCourse");
    const contentTitle = document.getElementById("contentTitle");
    const contentType = document.getElementById("contentType");
    const contentFile = document.getElementById("contentFile");
    const contentList = document.getElementById("contentList");
    const contentSearch = document.getElementById("contentSearch");
    const contentCourseFilter = document.getElementById("contentCourseFilter");
    const assignmentForm = document.getElementById("assignment-form");
    const assignmentCourse = document.getElementById("assignmentCourse");
    const assignmentTitle = document.getElementById("assignmentTitle");
    const assignmentDescription = document.getElementById("assignmentDescription");
    const assignmentDueDate = document.getElementById("assignmentDueDate");
    const assignmentList = document.getElementById("assignmentList");
    const assignmentSearch = document.getElementById("assignmentSearch");
    const assignmentCourseFilter = document.getElementById("assignmentCourseFilter");
    const forumThreadForm = document.getElementById("forum-thread-form");
    const forumCourse = document.getElementById("forumCourse");
    const threadTitle = document.getElementById("threadTitle");
    const threadContent = document.getElementById("threadContent");
    const forumList = document.getElementById("forumList");
    const forumSearch = document.getElementById("forumSearch");
    const forumCourseFilter = document.getElementById("forumCourseFilter");
    const quizForm = document.getElementById("quiz-form");
    const quizCourse = document.getElementById("quizCourse");
    const quizTitle = document.getElementById("quizTitle");
    const quizQuestions = document.getElementById("quizQuestions");
    const addQuizQuestion = document.getElementById("add-quiz-question");
    const quizQuestionModal = document.getElementById("quiz-question-modal");
    const quizQuestionForm = document.getElementById("quiz-question-form");
    const questionText = document.getElementById("questionText");
    const questionOptions = document.getElementById("questionOptions");
    const correctOption = document.getElementById("correctOption");
    const closeQuizQuestion = document.getElementById("close-quiz-question");
    const quizList = document.getElementById("quizList");
    const quizSearch = document.getElementById("quizSearch");
    const quizCourseFilter = document.getElementById("quizCourseFilter");

    let user = null, courses = {}, learners = {}, assessments = {}, certifications = {}, tickets = {}, notifications = [], contents = {}, assignments = {}, forums = {}, quizzes = {};
    let completionChartInstance = null, enrollmentTrendChartInstance = null, analyticsChartInstance = null, heatmapChartInstance = null;
    let currentQuizQuestions = [];

    // Show/hide loading spinner
    function showSpinner() { loadingSpinner.classList.remove("hidden"); }
    function hideSpinner() { loadingSpinner.classList.add("hidden"); }

    // Sidebar toggle
    toggleSidebar.addEventListener("click", () => {
      sidebar.classList.toggle("sidebar-hidden");
      sidebar.classList.toggle("sidebar-open");
    });

    // High contrast toggle
    toggleContrast.addEventListener("click", () => {
      document.body.classList.toggle("high-contrast");
      localStorage.setItem("highContrast", document.body.classList.contains("high-contrast"));
    });

    // Load high contrast preference
    if (localStorage.getItem("highContrast") === "true") {
      document.body.classList.add("high-contrast");
    }

    // Section switching
    document.querySelectorAll(".nav-button").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".section").forEach(section => section.classList.add("hidden"));
        document.getElementById(btn.dataset.section).classList.remove("hidden");
        if (window.innerWidth < 768) sidebar.classList.remove("sidebar-open");
      });
    });

    // Debounce function for search
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Sanitize input to prevent XSS
    function sanitizeInput(input) {
      const div = document.createElement("div");
      div.textContent = input;
      return div.innerHTML;
    }

    // Load overview metrics and charts
    function loadOverview() {
      showSpinner();
      onValue(ref(db, `users/${auth.currentUser.uid}`), snap => {
        user = snap.val();
        providerName.textContent = sanitizeInput(user.fullName || user.email);
      });

      onValue(ref(db, "courses"), snap => {
        courses = snap.val() || {};
        let courseCount = 0, learnerCount = 0, completedCount = 0, certCount = 0;
        const completionData = { labels: [], datasets: [{ label: "Completion Rate (%)", data: [], backgroundColor: "#2563eb", borderRadius: 4 }] };
        const enrollmentData = { labels: [], datasets: [{ label: "Enrollments", data: [], backgroundColor: "#10b981", borderRadius: 4 }] };

        const now = Date.now();
        const days = 30;
        const timePoints = Array.from({ length: days }, (_, i) => {
          const date = new Date(now - (days - i - 1) * 24 * 60 * 60 * 1000);
          return date.toLocaleDateString();
        });

        const enrollmentsByDay = timePoints.map(() => 0);

        for (const id in courses) {
          if (courses[id].providerId === auth.currentUser.uid && !courses[id].archived) {
            courseCount++;
            const enrolled = courses[id].enrolled?.length || 0;
            learnerCount += enrolled;
            const completion = courses[id].completions?.length || 0;
            completionData.labels.push(courses[id].name);
            completionData.datasets[0].data.push(enrolled > 0 ? (completion / enrolled * 100).toFixed(1) : 0);
            completedCount += completion;

            courses[id].enrolled?.forEach(learnerId => {
              const enrollmentDate = learners[learnerId]?.enrollmentDate || now;
              const daysSince = Math.floor((now - enrollmentDate) / (24 * 60 * 60 * 1000));
              if (daysSince < days) enrollmentsByDay[days - daysSince - 1]++;
            });
          }
        }

        coursesOffered.textContent = courseCount;
        enrolledLearners.textContent = learnerCount;
        completionRate.textContent = learnerCount > 0 ? (completedCount / learnerCount * 100).toFixed(1) + "%" : "0%";

        if (completionChartInstance) completionChartInstance.destroy();
        completionChartInstance = new Chart(completionChart, {
          type: "bar",
          data: completionData,
          options: {
            scales: { y: { beginAtZero: true, max: 100 } },
            plugins: {
              datalabels: { anchor: "end", align: "top", color: "#374151", font: { weight: "bold" } }
            }
          },
          plugins: [ChartDataLabels]
        });

        if (enrollmentTrendChartInstance) enrollmentTrendChartInstance.destroy();
        enrollmentTrendChartInstance = new Chart(enrollmentTrendChart, {
          type: "line",
          data: {
            labels: timePoints,
            datasets: [{ label: "Enrollments", data: enrollmentsByDay, borderColor: "#10b981", fill: false }]
          },
          options: {
            scales: { y: { beginAtZero: true } },
            plugins: { tooltip: { mode: "index", intersect: false } }
          }
        });

        onValue(ref(db, "certifications"), snap => {
          certifications = snap.val() || {};
          certCount = Object.values(certifications).filter(c => courses[c.courseId]?.providerId === auth.currentUser.uid).length;
          certificatesIssued.textContent = certCount;
          hideSpinner();
        });
      });
    }

    // Load learners
    function loadLearners() {
      showSpinner();
      onValue(ref(db, "users"), snap => {
        learners = snap.val() || {};
        onValue(ref(db, "courses"), snap => {
          courses = snap.val() || {};
          renderLearners();
          populateGroupFilter();
          populateCourseFilter();
          populateLearnerCourseDropdown();
          populateContentCourseDropdown();
          populateAssignmentCourseDropdown();
          populateForumCourseDropdown();
          populateQuizCourseDropdown();
          hideSpinner();
        });
      });
    }

    function renderLearners(filter = "", group = "") {
      learnerList.innerHTML = "";
      for (const id in learners) {
        const l = learners[id];
        if (l.role !== "learner" || l.providerId !== auth.currentUser.uid) continue;
        if (filter && !l.fullName?.toLowerCase().includes(filter.toLowerCase()) && !l.email.toLowerCase().includes(filter.toLowerCase()) && !l.metadata?.tags?.some(t => t.toLowerCase().includes(filter.toLowerCase()))) continue;
        if (group && !l.metadata?.tags?.includes(group)) continue;
        const learnerItem = document.createElement("div");
        learnerItem.className = "bg-gray-50 p-4 rounded shadow hover:shadow-md transition-shadow";
        const enrolledCourses = Object.values(courses).filter(c => c.providerId === auth.currentUser.uid && c.enrolled?.includes(id));
        learnerItem.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <p class="font-semibold">${sanitizeInput(l.fullName || l.email)}</p>
              <p class="text-sm text-gray-600">Email: ${sanitizeInput(l.email)} | Contact: ${sanitizeInput(l.metadata?.contact || "-")} | Tags: ${sanitizeInput(l.metadata?.tags?.join(", ") || "-")}</p>
              <p class="text-sm text-gray-600">Courses: ${enrolledCourses.map(c => sanitizeInput(c.name)).join(", ") || "None"}</p>
            </div>
            <div class="flex gap-2">
              <button onclick="viewLearnerProfile('${id}')" class="text-blue-600 hover:underline" aria-label="View profile for ${sanitizeInput(l.fullName || l.email)}" data-tooltip="View profile">Profile</button>
              <button onclick="editLearner('${id}')" class="text-blue-600 hover:underline" aria-label="Edit learner ${sanitizeInput(l.fullName || l.email)}" data-tooltip="Edit learner">Edit</button>
              <button onclick="deleteLearner('${id}')" class="text-red-600 hover:underline" aria-label="Delete learner ${sanitizeInput(l.fullName || l.email)}" data-tooltip="Delete learner">Delete</button>
            </div>
          </div>
        `;
        learnerList.appendChild(learnerItem);
      }
    }

    // Search learners
    const searchLearners = debounce((filter, group) => renderLearners(sanitizeInput(filter), group), 300);
    learnerSearch.addEventListener("input", () => searchLearners(learnerSearch.value, groupFilter.value));
    groupFilter.addEventListener("change", () => searchLearners(learnerSearch.value, groupFilter.value));

    // Populate group filter
    function populateGroupFilter() {
      const groups = new Set();
      for (const id in learners) {
        if (learners[id].role === "learner" && learners[id].providerId === auth.currentUser.uid) {
          learners[id].metadata?.tags?.forEach(tag => groups.add(tag));
        }
      }
      groupFilter.innerHTML = '<option value="">All Groups</option>';
      groups.forEach(group => {
        const option = document.createElement("option");
        option.value = group;
        option.textContent = sanitizeInput(group);
        groupFilter.appendChild(option);
      });
      groupFilterAnalytics.innerHTML = groupFilter.innerHTML;
    }

    // Populate learner course dropdown
    function populateLearnerCourseDropdown() {
      learnerCourse.innerHTML = '<option value="">Select Course (optional)</option>';
      for (const id in courses) {
        if (courses[id].providerId === auth.currentUser.uid && !courses[id].archived) {
          const option = document.createElement("option");
          option.value = id;
          option.textContent = sanitizeInput(courses[id].name);
          learnerCourse.appendChild(option);
        }
      }
    }

    // Add learner
    openAddLearner.addEventListener("click", () => {
      addLearnerModal.style.display = "block";
      learnerFullName.focus();
    });

    closeAddLearner.addEventListener("click", () => {
      addLearnerModal.style.display = "none";
      addLearnerForm.reset();
    });

    addLearnerForm.addEventListener("submit", async e => {
      e.preventDefault();
      const fullName = sanitizeInput(learnerFullName.value.trim());
      const email = sanitizeInput(learnerEmail.value.trim());
      const contact = sanitizeInput(learnerContact.value.trim());
      const tags = learnerTags.value.split(",").map(t => sanitizeInput(t.trim())).filter(t => t);
      const courseId = learnerCourse.value;
      if (!fullName || !email) {
        alert("Please enter full name and email.");
        return;
      }
      showSpinner();
      try {
        const { user: newUser } = await createUserWithEmailAndPassword(auth, email, generateTempPassword());
        await set(ref(db, `users/${newUser.uid}`), {
          fullName,
          email,
          role: "learner",
          providerId: auth.currentUser.uid,
          enrollmentDate: Date.now(),
          progress: {},
          metadata: { contact: contact || null, tags, version: "1.0" }
        });
        if (courseId) {
          await runTransaction(ref(db, `courses/${courseId}`), course => {
            course = course || { enrolled: [] };
            course.enrolled = course.enrolled || [];
            if (!course.enrolled.includes(newUser.uid)) course.enrolled.push(newUser.uid);
            return course;
          });
        }
        logAudit(`Added learner ${fullName} (${email})`);
        alert("Learner added successfully!");
        addLearnerModal.style.display = "none";
        addLearnerForm.reset();
      } catch (err) {
        console.error("Error adding learner:", err);
        alert("Failed to add learner.");
      }
      hideSpinner();
    });

    // Generate temporary password
    function generateTempPassword() {
      return Math.random().toString(36).slice(-8);
    }

    // Bulk upload learners
    openBulkUpload.addEventListener("click", () => {
      bulkUploadModal.style.display = "block";
    });

    closeBulkUpload.addEventListener("click", () => {
      bulkUploadModal.style.display = "none";
      bulkUploadForm.reset();
    });

    bulkUploadForm.addEventListener("submit", async e => {
      e.preventDefault();
      const file = learnerCSV.files[0];
      if (!file) {
        alert("Please select a CSV file.");
        return;
      }
      showSpinner();
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: async results => {
          try {
            for (const row of results.data) {
              const fullName = sanitizeInput(row.fullName?.trim() || "");
              const email = sanitizeInput(row.email?.trim() || "");
              const contact = sanitizeInput(row.contact?.trim() || "");
              const tags = row.tags ? row.tags.split(",").map(t => sanitizeInput(t.trim())).filter(t => t) : [];
              const courseId = row.courseId?.trim();
              if (!fullName || !email) continue;
              const { user: newUser } = await createUserWithEmailAndPassword(auth, email, generateTempPassword());
              await set(ref(db, `users/${newUser.uid}`), {
                fullName,
                email,
                role: "learner",
                providerId: auth.currentUser.uid,
                enrollmentDate: Date.now(),
                progress: {},
                metadata: { contact: contact || null, tags, version: "1.0" }
              });
              if (courseId && courses[courseId]?.providerId === auth.currentUser.uid) {
                await runTransaction(ref(db, `courses/${courseId}`), course => {
                  course = course || { enrolled: [] };
                  course.enrolled = course.enrolled || [];
                  if (!course.enrolled.includes(newUser.uid)) course.enrolled.push(newUser.uid);
                  return course;
                });
              }
              logAudit(`Bulk added learner ${fullName} (${email})`);
            }
            alert("Bulk upload completed!");
            bulkUploadModal.style.display = "none";
            bulkUploadForm.reset();
          } catch (err) {
            console.error("Error during bulk upload:", err);
            alert("Failed to upload some learners.");
          }
          hideSpinner();
        },
        error: err => {
          console.error("CSV parsing error:", err);
          alert("Failed to parse CSV file.");
          hideSpinner();
        }
      });
    });

    // Edit learner
    window.editLearner = async learnerId => {
      const l = learners[learnerId];
      learnerFullName.value = l.fullName || "";
      learnerEmail.value = l.email;
      learnerContact.value = l.metadata?.contact || "";
      learnerTags.value = l.metadata?.tags?.join(", ") || "";
      learnerCourse.value = Object.keys(courses).find(id => courses[id].enrolled?.includes(learnerId)) || "";
      addLearnerModal.style.display = "block";
      addLearnerForm.onsubmit = async e => {
        e.preventDefault();
        const fullName = sanitizeInput(learnerFullName.value.trim());
        const email = sanitizeInput(learnerEmail.value.trim());
        const contact = sanitizeInput(learnerContact.value.trim());
        const tags = learnerTags.value.split(",").map(t => sanitizeInput(t.trim())).filter(t => t);
        const newCourseId = learnerCourse.value;
        if (!fullName || !email) {
          alert("Please enter full name and email.");
          return;
        }
        showSpinner();
        try {
          await update(ref(db, `users/${learnerId}`), {
            fullName,
            email,
            metadata: { contact: contact || null, tags, version: "1.1" }
          });
          const oldCourseId = Object.keys(courses).find(id => courses[id].enrolled?.includes(learnerId));
          if (oldCourseId !== newCourseId) {
            if (oldCourseId) {
              await runTransaction(ref(db, `courses/${oldCourseId}`), course => {
                course = course || { enrolled: [] };
                course.enrolled = course.enrolled.filter(id => id !== learnerId);
                return course;
              });
            }
            if (newCourseId) {
              await runTransaction(ref(db, `courses/${newCourseId}`), course => {
                course = course || { enrolled: [] };
                course.enrolled = course.enrolled || [];
                if (!course.enrolled.includes(learnerId)) course.enrolled.push(learnerId);
                return course;
              });
            }
          }
          logAudit(`Edited learner ${fullName} (${email})`);
          alert("Learner updated successfully!");
          addLearnerModal.style.display = "none";
          addLearnerForm.reset();
          addLearnerForm.onsubmit = null; // Reset to default add behavior
        } catch (err) {
          console.error("Error editing learner:", err);
          alert("Failed to edit learner.");
        }
        hideSpinner();
      };
    };

    // Delete learner
    window.deleteLearner = async learnerId => {
      if (!confirm("Are you sure you want to delete this learner?")) return;
      showSpinner();
      try {
        await remove(ref(db, `users/${learnerId}`));
        for (const courseId in courses) {
          if (courses[courseId].enrolled?.includes(learnerId)) {
            await runTransaction(ref(db, `courses/${courseId}`), course => {
              course = course || { enrolled: [] };
              course.enrolled = course.enrolled.filter(id => id !== learnerId);
              return course;
            });
          }
        }
        logAudit(`Deleted learner ${learners[learnerId].fullName || learners[learnerId].email}`);
        alert("Learner deleted successfully!");
      } catch (err) {
        console.error("Error deleting learner:", err);
        alert("Failed to delete learner.");
      }
      hideSpinner();
    };

    // View learner profile
    window.viewLearnerProfile = learnerId => {
      const l = learners[learnerId];
      const enrolledCourses = Object.values(courses).filter(c => c.providerId === auth.currentUser.uid && c.enrolled?.includes(learnerId));
      const certs = Object.values(certifications).filter(c => c.learnerId === learnerId && courses[c.courseId]?.providerId === auth.currentUser.uid);
      const activityLogs = notifications.filter(n => n.learnerId === learnerId);
      const assignments = Object.values(assignments).filter(a => a.learnerId === learnerId);
      const modal = document.createElement("div");
      modal.className = "modal";
      modal.style.display = "block";
      modal.innerHTML = `
        <div class="modal-content">
          <h3 class="text-lg font-semibold mb-4">Learner Profile: ${sanitizeInput(l.fullName || l.email)}</h3>
          <p class="text-sm text-gray-600">Email: ${sanitizeInput(l.email)}</p>
          <p class="text-sm text-gray-600">Contact: ${sanitizeInput(l.metadata?.contact || "-")}</p>
          <p class="text-sm text-gray-600">Tags: ${sanitizeInput(l.metadata?.tags?.join(", ") || "-")}</p>
          <p class="text-sm text-gray-600">Enrolled Courses: ${enrolledCourses.map(c => sanitizeInput(c.name)).join(", ") || "None"}</p>
          <p class="text-sm text-gray-600">Certificates: ${certs.map(c => `<a href="#" onclick="downloadCertificate('${c.id}')" class="text-blue-600 hover:underline">${sanitizeInput(courses[c.courseId].name)}</a>`).join(", ") || "None"}</p>
          <h4 class="text-md font-semibold mt-4 mb-2">Assignments</h4>
          <ul class="text-sm text-gray-600 space-y-1">${assignments.map(a => `<li>${sanitizeInput(a.title)}: ${a.status} (Submitted: ${a.submittedAt ? new Date(a.submittedAt).toLocaleDateString() : "Not submitted"})</li>`).join("") || "No assignments"}</ul>
          <h4 class="text-md font-semibold mt-4 mb-2">Activity Log</h4>
          <ul class="text-sm text-gray-600 space-y-1">${activityLogs.map(n => `<li>${sanitizeInput(n.message)} (${new Date(n.timestamp).toLocaleString()})</li>`).join("") || "No activity"}</ul>
          <button class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 mt-4" onclick="this.parentElement.parentElement.remove()" data-tooltip="Close profile">Close</button>
        </div>
      `;
      document.body.appendChild(modal);
    };

    // Load courses
    function loadCourses() {
      showSpinner();
      onValue(ref(db, "courses"), snap => {
        courses = snap.val() || {};
        renderCourses();
        populateCourseFilter();
        populateLearnerCourseDropdown();
        populateContentCourseDropdown();
        populateAssignmentCourseDropdown();
        populateForumCourseDropdown();
        populateQuizCourseDropdown();
        hideSpinner();
      });
    }

    function renderCourses(filter = "") {
      courseList.innerHTML = "";
      for (const id in courses) {
        const c = courses[id];
        if (c.providerId !== auth.currentUser.uid || (filter && !c.name.toLowerCase().includes(filter.toLowerCase()) && !c.metadata?.tags?.some(t => t.toLowerCase().includes(filter.toLowerCase())))) continue;
        const courseItem = document.createElement("div");
        courseItem.className = "bg-gray-50 p-4 rounded shadow flex justify-between items-center hover:shadow-md transition-shadow";
        courseItem.innerHTML = `
          <div>
            <p class="font-semibold">${sanitizeInput(c.name)}</p>
            <p class="text-sm text-gray-600">Tags: ${sanitizeInput(c.metadata?.tags?.join(", ") || "-")} | Enrolled: ${c.enrolled?.length || 0}</p>
          </div>
          <div class="flex gap-2">
            <button onclick="editCourse('${id}')" class="text-blue-600 hover:underline" aria-label="Edit course ${sanitizeInput(c.name)}" data-tooltip="Edit course">Edit</button>
            <button onclick="archiveCourse('${id}')" class="text-red-600 hover:underline" aria-label="${c.archived ? "Unarchive" : "Archive"} course ${sanitizeInput(c.name)}" data-tooltip="${c.archived ? "Unarchive" : "Archive"} course">${c.archived ? "Unarchive" : "Archive"}</button>
          </div>
        `;
        courseList.appendChild(courseItem);
      }
    }

    // Search courses
    const searchCourses = debounce(filter => renderCourses(sanitizeInput(filter)), 300);
    courseSearch.addEventListener("input", () => searchCourses(courseSearch.value));

    // Add course
    courseForm.addEventListener("submit", async e => {
      e.preventDefault();
      const name = sanitizeInput(courseName.value.trim());
      const tags = courseTags.value.split(",").map(t => sanitizeInput(t.trim())).filter(t => t);
      if (!name) {
        alert("Please enter a course name.");
        return;
      }
      showSpinner();
      try {
        await push(ref(db, "courses"), {
          providerId: auth.currentUser.uid,
          name,
          metadata: { tags, version: "1.0" },
          enrolled: [],
          completions: [],
          archived: false,
          createdAt: Date.now()
        });
        logAudit(`Added course ${name}`);
        alert("Course added successfully!");
        courseForm.reset();
      } catch (err) {
        console.error("Error adding course:", err);
        alert("Failed to add course.");
      }
      hideSpinner();
    });

    // Edit course
    window.editCourse = async courseId => {
      const c = courses[courseId];
      const newName = prompt("Edit course name:", c.name);
      const newTags = prompt("Edit tags (comma-separated):", c.metadata?.tags?.join(", ") || "");
      if (newName && newTags) {
        showSpinner();
        try {
          await update(ref(db, `courses/${courseId}`), {
            name: sanitizeInput(newName),
            metadata: { tags: newTags.split(",").map(t => sanitizeInput(t.trim())), version: "1.1" }
          });
          logAudit(`Edited course ${newName}`);
          alert("Course updated successfully!");
        } catch (err) {
          console.error("Error editing course:", err);
          alert("Failed to edit course.");
        }
        hideSpinner();
      }
    };

    // Archive/unarchive course
    window.archiveCourse = async courseId => {
      showSpinner();
      try {
        await update(ref(db, `courses/${courseId}`), { archived: !courses[courseId].archived });
        logAudit(`Course ${courses[courseId].name} ${courses[courseId].archived ? "unarchived" : "archived"}`);
        alert(`Course ${courses[courseId].archived ? "unarchived" : "archived"} successfully!`);
      } catch (err) {
        console.error("Error archiving course:", err);
        alert("Failed to archive course.");
      }
      hideSpinner();
    };

    // Load course content
    function loadContent() {
      showSpinner();
      onValue(ref(db, "contents"), snap => {
        contents = snap.val() || {};
        renderContent();
        hideSpinner();
      });
    }

    function populateContentCourseDropdown() {
      contentCourse.innerHTML = '<option value="">Select Course</option>';
      contentCourseFilter.innerHTML = '<option value="">All Courses</option>';
      for (const id in courses) {
        if (courses[id].providerId === auth.currentUser.uid && !courses[id].archived) {
          const option = document.createElement("option");
          option.value = id;
          option.textContent = sanitizeInput(courses[id].name);
          contentCourse.appendChild(option);
          contentCourseFilter.appendChild(option.cloneNode(true));
        }
      }
    }

    function renderContent(filter = "", courseFilter = "") {
      contentList.innerHTML = "";
      for (const id in contents) {
        const c = contents[id];
        if (c.providerId !== auth.currentUser.uid) continue;
        if (filter && !c.title.toLowerCase().includes(filter.toLowerCase())) continue;
        if (courseFilter && c.courseId !== courseFilter) continue;
        const contentItem = document.createElement("div");
        contentItem.className = "bg-gray-50 p-4 rounded shadow hover:shadow-md transition-shadow";
        contentItem.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <p class="font-semibold">${sanitizeInput(c.title)}</p>
              <p class="text-sm text-gray-600">Course: ${sanitizeInput(courses[c.courseId]?.name || "Unknown")} | Type: ${sanitizeInput(c.type)}</p>
              <p class="text-sm text-gray-600">URL: <a href="${sanitizeInput(c.url)}" target="_blank" class="text-blue-600 hover:underline">View</a></p>
            </div>
            <div class="flex gap-2">
              <button onclick="deleteContent('${id}')" class="text-red-600 hover:underline" aria-label="Delete content ${sanitizeInput(c.title)}" data-tooltip="Delete content">Delete</button>
            </div>
          </div>
        `;
        contentList.appendChild(contentItem);
      }
    }

    // Search content
    const searchContent = debounce((filter, course) => renderContent(sanitizeInput(filter), course), 300);
    contentSearch.addEventListener("input", () => searchContent(contentSearch.value, contentCourseFilter.value));
    contentCourseFilter.addEventListener("change", () => searchContent(contentSearch.value, contentCourseFilter.value));

    // Upload content
    contentUploadForm.addEventListener("submit", async e => {
      e.preventDefault();
      const courseId = contentCourse.value;
      const title = sanitizeInput(contentTitle.value.trim());
      const type = contentType.value;
      const file = contentFile.files[0];
      if (!courseId || !title || !file) {
        alert("Please select a course, enter a title, and upload a file.");
        return;
      }
      showSpinner();
      try {
        const fileRef = storageRef(storage, `content/${auth.currentUser.uid}/${Date.now()}_${file.name}`);
        await uploadBytes(fileRef, file);
        const url = await getDownloadURL(fileRef);
        await push(ref(db, "contents"), {
          providerId: auth.currentUser.uid,
          courseId,
          title,
          type,
          url,
          createdAt: Date.now()
        });
        logAudit(`Uploaded content ${title} for course ${courses[courseId].name}`);
        alert("Content uploaded successfully!");
        contentUploadForm.reset();
      } catch (err) {
        console.error("Error uploading content:", err);
        alert("Failed to upload content.");
      }
      hideSpinner();
    });

    // Delete content
    window.deleteContent = async contentId => {
      if (!confirm("Are you sure you want to delete this content?")) return;
      showSpinner();
      try {
        await remove(ref(db, `contents/${contentId}`));
        logAudit(`Deleted content ${contents[contentId].title}`);
        alert("Content deleted successfully!");
      } catch (err) {
        console.error("Error deleting content:", err);
        alert("Failed to delete content.");
      }
      hideSpinner();
    };

    // Load assignments
    function loadAssignments() {
      showSpinner();
      onValue(ref(db, "assignments"), snap => {
        assignments = snap.val() || {};
        renderAssignments();
        hideSpinner();
      });
    }

    function populateAssignmentCourseDropdown() {
      assignmentCourse.innerHTML = '<option value="">Select Course</option>';
      assignmentCourseFilter.innerHTML = '<option value="">All Courses</option>';
      for (const id in courses) {
        if (courses[id].providerId === auth.currentUser.uid && !courses[id].archived) {
          const option = document.createElement("option");
          option.value = id;
          option.textContent = sanitizeInput(courses[id].name);
          assignmentCourse.appendChild(option);
          assignmentCourseFilter.appendChild(option.cloneNode(true));
        }
      }
    }

    function renderAssignments(filter = "", courseFilter = "") {
      assignmentList.innerHTML = "";
      for (const id in assignments) {
        const a = assignments[id];
        if (a.providerId !== auth.currentUser.uid) continue;
        if (filter && !a.title.toLowerCase().includes(filter.toLowerCase()) && !learners[a.learnerId]?.fullName?.toLowerCase().includes(filter.toLowerCase())) continue;
        if (courseFilter && a.courseId !== courseFilter) continue;
        const assignmentItem = document.createElement("div");
        assignmentItem.className = "bg-gray-50 p-4 rounded shadow hover:shadow-md transition-shadow";
        assignmentItem.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <p class="font-semibold">${sanitizeInput(a.title)}</p>
              <p class="text-sm text-gray-600">Course: ${sanitizeInput(courses[a.courseId]?.name || "Unknown")} | Learner: ${sanitizeInput(learners[a.learnerId]?.fullName || "Unknown")}</p>
              <p class="text-sm text-gray-600">Status: ${sanitizeInput(a.status)} | Due: ${new Date(a.dueDate).toLocaleDateString()}</p>
              <p class="text-sm text-gray-600">Submission: ${a.submissionUrl ? `<a href="${sanitizeInput(a.submissionUrl)}" target="_blank" class="text-blue-600 hover:underline">View</a>` : "Not submitted"}</p>
            </div>
            <div class="flex gap-2">
              ${a.status === "submitted" ? `<button onclick="reviewAssignment('${id}')" class="text-blue-600 hover:underline" aria-label="Review assignment ${sanitizeInput(a.title)}" data-tooltip="Review assignment">Review</button>` : ""}
              <button onclick="deleteAssignment('${id}')" class="text-red-600 hover:underline" aria-label="Delete assignment ${sanitizeInput(a.title)}" data-tooltip="Delete assignment">Delete</button>
            </div>
          </div>
        `;
        assignmentList.appendChild(assignmentItem);
      }
    }

    // Search assignments
    const searchAssignments = debounce((filter, course) => renderAssignments(sanitizeInput(filter), course), 300);
    assignmentSearch.addEventListener("input", () => searchAssignments(assignmentSearch.value, assignmentCourseFilter.value));
    assignmentCourseFilter.addEventListener("change", () => searchAssignments(assignmentSearch.value, assignmentCourseFilter.value));

    // Create assignment
    assignmentForm.addEventListener("submit", async e => {
      e.preventDefault();
      const courseId = assignmentCourse.value;
      const title = sanitizeInput(assignmentTitle.value.trim());
      const description = sanitizeInput(assignmentDescription.value.trim());
      const dueDate = new Date(assignmentDueDate.value).getTime();
      if (!courseId || !title || !description || !dueDate) {
        alert("Please fill in all required fields.");
        return;
      }
      showSpinner();
      try {
        await push(ref(db, "assignments"), {
          providerId: auth.currentUser.uid,
          courseId,
          title,
          description,
          dueDate,
          status: "assigned",
          createdAt: Date.now()
        });
        logAudit(`Created assignment ${title} for course ${courses[courseId].name}`);
        alert("Assignment created successfully!");
        assignmentForm.reset();
      } catch (err) {
        console.error("Error creating assignment:", err);
        alert("Failed to create assignment.");
      }
      hideSpinner();
    });

    // Review assignment
    window.reviewAssignment = async assignmentId => {
      const feedback = prompt("Enter feedback for the assignment:");
      const grade = prompt("Enter grade (0-100):");
      if (feedback && grade && !isNaN(grade) && grade >= 0 && grade <= 100) {
        showSpinner();
        try {
          await update(ref(db, `assignments/${assignmentId}`), {
            status: "graded",
            feedback: sanitizeInput(feedback),
            grade: parseInt(grade),
            reviewedAt: Date.now()
          });
          logAudit(`Reviewed assignment ${assignments[assignmentId].title}`);
          alert("Assignment reviewed successfully!");
        } catch (err) {
          console.error("Error reviewing assignment:", err);
          alert("Failed to review assignment.");
        }
        hideSpinner();
      } else {
        alert("Invalid feedback or grade.");
      }
    };

    // Delete assignment
    window.deleteAssignment = async assignmentId => {
      if (!confirm("Are you sure you want to delete this assignment?")) return;
      showSpinner();
      try {
        await remove(ref(db, `assignments/${assignmentId}`));
        logAudit(`Deleted assignment ${assignments[assignmentId].title}`);
        alert("Assignment deleted successfully!");
      } catch (err) {
        console.error("Error deleting assignment:", err);
        alert("Failed to delete assignment.");
      }
      hideSpinner();
    };

    // Load forums
    function loadForums() {
      showSpinner();
      onValue(ref(db, "forums"), snap => {
        forums = snap.val() || {};
        renderForums();
        hideSpinner();
      });
    }

    function populateForumCourseDropdown() {
      forumCourse.innerHTML = '<option value="">Select Course</option>';
      forumCourseFilter.innerHTML = '<option value="">All Courses</option>';
      for (const id in courses) {
        if (courses[id].providerId === auth.currentUser.uid && !courses[id].archived) {
          const option = document.createElement("option");
          option.value = id;
          option.textContent = sanitizeInput(courses[id].name);
          forumCourse.appendChild(option);
          forumCourseFilter.appendChild(option.cloneNode(true));
        }
      }
    }

   function renderForums(filter = "", courseFilter = "") {
  forumList.innerHTML = "";
  for (const id in forums) {
    const f = forums[id];
    if (f.providerId !== auth.currentUser.uid) continue;
    if (filter && !f.title.toLowerCase().includes(filter.toLowerCase())) continue;
    if (courseFilter && f.courseId !== courseFilter) continue;
    const forumItem = document.createElement("div");
    forumItem.className = "bg-gray-50 p-4 rounded shadow hover:shadow-md transition-shadow";
    forumItem.innerHTML = `
      <div class="flex justify-between items-center">
        <div>
          <p class="font-semibold">${sanitizeInput(f.title)}</p>
          <p class="text-sm text-gray-600">Course: ${sanitizeInput(courses[f.courseId]?.name || "Unknown")} | Posts: ${f.posts?.length || 0}</p>
          <p class="text-sm text-gray-600">Created: ${new Date(f.createdAt).toLocaleDateString()}</p>
        </div>
        <div class="flex gap-2">
          <button onclick="viewForum('${id}')" class="text-blue-600 hover:underline" aria-label="View forum ${sanitizeInput(f.title)}" data-tooltip="View forum">View</button>
          <button onclick="deleteForum('${id}')" class="text-red-600 hover:underline" aria-label="Delete forum ${sanitizeInput(f.title)}" data-tooltip="Delete forum">Delete</button>
        </div>
      </div>
    `;
    forumList.appendChild(forumItem);
  }
}

// Search forums
const searchForums = debounce((filter, course) => renderForums(sanitizeInput(filter), course), 300);
forumSearch.addEventListener("input", () => searchForums(forumSearch.value, forumCourseFilter.value));
forumCourseFilter.addEventListener("change", () => searchForums(forumSearch.value, forumCourseFilter.value));

// Create forum thread
forumThreadForm.addEventListener("submit", async e => {
  e.preventDefault();
  const courseId = forumCourse.value;
  const title = sanitizeInput(threadTitle.value.trim());
  const content = sanitizeInput(threadContent.value.trim());
  if (!courseId || !title || !content) {
    alert("Please fill in all required fields.");
    return;
  }
  showSpinner();
  try {
    await push(ref(db, "forums"), {
      providerId: auth.currentUser.uid,
      courseId,
      title,
      posts: [{ content, postedBy: auth.currentUser.uid, timestamp: Date.now() }],
      createdAt: Date.now()
    });
    logAudit(`Created forum thread ${title} for course ${courses[courseId].name}`);
    alert("Forum thread created successfully!");
    forumThreadForm.reset();
  } catch (err) {
    console.error("Error creating forum thread:", err);
    alert("Failed to create forum thread.");
  }
  hideSpinner();
});

// View forum
window.viewForum = async forumId => {
  const f = forums[forumId];
  const modal = document.createElement("div");
  modal.className = "modal";
  modal.style.display = "block";
  modal.innerHTML = `
    <div class="modal-content">
      <h3 class="text-lg font-semibold mb-4">Forum: ${sanitizeInput(f.title)}</h3>
      <p class="text-sm text-gray-600 mb-2">Course: ${sanitizeInput(courses[f.courseId]?.name || "Unknown")}</p>
      <div id="forumPosts" class="space-y-2 mb-4"></div>
      <form id="post-form" class="mb-4">
        <textarea id="newPost" placeholder="Add a new post..." class="border p-2 rounded w-full mb-2" aria-label="Enter new post content" required></textarea>
        <div class="flex gap-2">
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" data-tooltip="Post reply">Post</button>
          <button type="button" onclick="this.closest('.modal').remove()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700" data-tooltip="Close forum">Close</button>
        </div>
      </form>
    </div>
  `;
  document.body.appendChild(modal);
  const forumPosts = modal.querySelector("#forumPosts");
  f.posts?.forEach(post => {
    const postDiv = document.createElement("div");
    postDiv.className = "border-l-2 border-blue-600 pl-2";
    postDiv.innerHTML = `
      <p class="text-sm">${sanitizeInput(post.content)}</p>
      <p class="text-xs text-gray-500">By ${sanitizeInput(learners[post.postedBy]?.fullName || "Provider")} on ${new Date(post.timestamp).toLocaleString()}</p>
    `;
    forumPosts.appendChild(postDiv);
  });
  modal.querySelector("#post-form").addEventListener("submit", async e => {
    e.preventDefault();
    const content = sanitizeInput(modal.querySelector("#newPost").value.trim());
    if (!content) {
      alert("Please enter post content.");
      return;
    }
    showSpinner();
    try {
      await runTransaction(ref(db, `forums/${forumId}`), forum => {
        forum = forum || { posts: [] };
        forum.posts = forum.posts || [];
        forum.posts.push({ content, postedBy: auth.currentUser.uid, timestamp: Date.now() });
        return forum;
      });
      logAudit(`Posted in forum ${f.title}`);
      modal.remove();
      viewForum(forumId); // Refresh forum view
    } catch (err) {
      console.error("Error posting to forum:", err);
      alert("Failed to post to forum.");
    }
    hideSpinner();
  });
};

// Delete forum
window.deleteForum = async forumId => {
  if (!confirm("Are you sure you want to delete this forum thread?")) return;
  showSpinner();
  try {
    await remove(ref(db, `forums/${forumId}`));
    logAudit(`Deleted forum ${forums[forumId].title}`);
    alert("Forum thread deleted successfully!");
  } catch (err) {
    console.error("Error deleting forum:", err);
    alert("Failed to delete forum thread.");
  }
  hideSpinner();
};

// Load quizzes
function loadQuizzes() {
  showSpinner();
  onValue(ref(db, "quizzes"), snap => {
    quizzes = snap.val() || {};
    renderQuizzes();
    hideSpinner();
  });
}

function populateQuizCourseDropdown() {
  quizCourse.innerHTML = '<option value="">Select Course</option>';
  quizCourseFilter.innerHTML = '<option value="">All Courses</option>';
  for (const id in courses) {
    if (courses[id].providerId === auth.currentUser.uid && !courses[id].archived) {
      const option = document.createElement("option");
      option.value = id;
      option.textContent = sanitizeInput(courses[id].name);
      quizCourse.appendChild(option);
      quizCourseFilter.appendChild(option.cloneNode(true));
    }
  }
}

function renderQuizzes(filter = "", courseFilter = "") {
  quizList.innerHTML = "";
  for (const id in quizzes) {
    const q = quizzes[id];
    if (q.providerId !== auth.currentUser.uid) continue;
    if (filter && !q.title.toLowerCase().includes(filter.toLowerCase())) continue;
    if (courseFilter && q.courseId !== courseFilter) continue;
    const quizItem = document.createElement("div");
    quizItem.className = "bg-gray-50 p-4 rounded shadow hover:shadow-md transition-shadow";
    quizItem.innerHTML = `
      <div class="flex justify-between items-center">
        <div>
          <p class="font-semibold">${sanitizeInput(q.title)}</p>
          <p class="text-sm text-gray-600">Course: ${sanitizeInput(courses[q.courseId]?.name || "Unknown")} | Questions: ${q.questions?.length || 0}</p>
          <p class="text-sm text-gray-600">Created: ${new Date(q.createdAt).toLocaleDateString()}</p>
        </div>
        <div class="flex gap-2">
          <button onclick="viewQuiz('${id}')" class="text-blue-600 hover:underline" aria-label="View quiz ${sanitizeInput(q.title)}" data-tooltip="View quiz">View</button>
          <button onclick="deleteQuiz('${id}')" class="text-red-600 hover:underline" aria-label="Delete quiz ${sanitizeInput(q.title)}" data-tooltip="Delete quiz">Delete</button>
        </div>
      </div>
    `;
    quizList.appendChild(quizItem);
  }
}

// Search quizzes
const searchQuizzes = debounce((filter, course) => renderQuizzes(sanitizeInput(filter), course), 300);
quizSearch.addEventListener("input", () => searchQuizzes(quizSearch.value, quizCourseFilter.value));
quizCourseFilter.addEventListener("change", () => searchQuizzes(quizSearch.value, quizCourseFilter.value));

// Add quiz question
addQuizQuestion.addEventListener("click", () => {
  quizQuestionModal.style.display = "block";
  questionText.focus();
});

closeQuizQuestion.addEventListener("click", () => {
  quizQuestionModal.style.display = "none";
  quizQuestionForm.reset();
});

quizQuestionForm.addEventListener("submit", e => {
  e.preventDefault();
  const question = sanitizeInput(questionText.value.trim());
  const options = questionOptions.value.split(",").map(o => sanitizeInput(o.trim())).filter(o => o);
  const correct = parseInt(correctOption.value);
  if (!question || options.length < 2 || isNaN(correct) || correct < 0 || correct >= options.length) {
    alert("Please enter a valid question, at least two options, and a correct option index.");
    return;
  }
  currentQuizQuestions.push({ question, options, correct });
  quizQuestionModal.style.display = "none";
  quizQuestionForm.reset();
  renderQuizQuestions();
});

function renderQuizQuestions() {
  quizQuestions.innerHTML = "";
  currentQuizQuestions.forEach((q, index) => {
    const questionDiv = document.createElement("div");
    questionDiv.className = "border p-2 rounded";
    questionDiv.innerHTML = `
      <p class="font-semibold">${sanitizeInput(q.question)}</p>
      <p class="text-sm text-gray-600">Options: ${sanitizeInput(q.options.join(", "))}</p>
      <p class="text-sm text-gray-600">Correct: ${sanitizeInput(q.options[q.correct])}</p>
      <button onclick="removeQuizQuestion(${index})" class="text-red-600 hover:underline text-sm" aria-label="Remove question" data-tooltip="Remove question">Remove</button>
    `;
    quizQuestions.appendChild(questionDiv);
  });
}

window.removeQuizQuestion = index => {
  currentQuizQuestions.splice(index, 1);
  renderQuizQuestions();
};

// Create quiz
quizForm.addEventListener("submit", async e => {
  e.preventDefault();
  const courseId = quizCourse.value;
  const title = sanitizeInput(quizTitle.value.trim());
  if (!courseId || !title || currentQuizQuestions.length === 0) {
    alert("Please select a course, enter a title, and add at least one question.");
    return;
  }
  showSpinner();
  try {
    await push(ref(db, "quizzes"), {
      providerId: auth.currentUser.uid,
      courseId,
      title,
      questions: currentQuizQuestions,
      createdAt: Date.now()
    });
    logAudit(`Created quiz ${title} for course ${courses[courseId].name}`);
    alert("Quiz created successfully!");
    quizForm.reset();
    currentQuizQuestions = [];
    quizQuestions.innerHTML = "";
  } catch (err) {
    console.error("Error creating quiz:", err);
    alert("Failed to create quiz.");
  }
  hideSpinner();
});

// View quiz
window.viewQuiz = async quizId => {
  const q = quizzes[quizId];
  const modal = document.createElement("div");
  modal.className = "modal";
  modal.style.display = "block";
  modal.innerHTML = `
    <div class="modal-content">
      <h3 class="text-lg font-semibold mb-4">Quiz: ${sanitizeInput(q.title)}</h3>
      <p class="text-sm text-gray-600 mb-2">Course: ${sanitizeInput(courses[q.courseId]?.name || "Unknown")}</p>
      <div id="quizQuestionsView" class="space-y-2 mb-4"></div>
      <button class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700" onclick="this.closest('.modal').remove()" data-tooltip="Close quiz">Close</button>
    </div>
  `;
  document.body.appendChild(modal);
  const questionsView = modal.querySelector("#quizQuestionsView");
  q.questions.forEach(q => {
    const questionDiv = document.createElement("div");
    questionDiv.className = "border p-2 rounded";
    questionDiv.innerHTML = `
      <p class="font-semibold">${sanitizeInput(q.question)}</p>
      <p class="text-sm text-gray-600">Options: ${sanitizeInput(q.options.join(", "))}</p>
      <p class="text-sm text-gray-600">Correct: ${sanitizeInput(q.options[q.correct])}</p>
    `;
    questionsView.appendChild(questionDiv);
  });
};

// Delete quiz
window.deleteQuiz = async quizId => {
  if (!confirm("Are you sure you want to delete this quiz?")) return;
  showSpinner();
  try {
    await remove(ref(db, `quizzes/${quizId}`));
    logAudit(`Deleted quiz ${quizzes[quizId].title}`);
    alert("Quiz deleted successfully!");
  } catch (err) {
    console.error("Error deleting quiz:", err);
    alert("Failed to delete quiz.");
  }
  hideSpinner();
};

// Load progress
function loadProgress() {
  showSpinner();
  onValue(ref(db, "users"), snap => {
    learners = snap.val() || {};
    renderProgress();
    hideSpinner();
  });
}

function renderProgress(filter = "") {
  progressList.innerHTML = "";
  for (const id in learners) {
    const l = learners[id];
    if (l.role !== "learner" || l.providerId !== auth.currentUser.uid) continue;
    if (filter && !l.fullName?.toLowerCase().includes(filter.toLowerCase()) && !l.email.toLowerCase().includes(filter.toLowerCase())) continue;
    const enrolledCourses = Object.values(courses).filter(c => c.providerId === auth.currentUser.uid && c.enrolled?.includes(id));
    const progressItem = document.createElement("div");
    progressItem.className = "bg-gray-50 p-4 rounded shadow hover:shadow-md transition-shadow";
    let progressHTML = "";
    enrolledCourses.forEach(c => {
      const progress = l.progress?.[c.id] || { completed: 0, total: 100, milestones: [] };
      const percentage = (progress.completed / progress.total * 100).toFixed(1);
      progressHTML += `
        <div class="mt-2">
          <p class="font-semibold">${sanitizeInput(c.name)}</p>
          <p class="text-sm text-gray-600">Progress: ${percentage}%</p>
          <p class="text-sm text-gray-600">Milestones: ${sanitizeInput(progress.milestones?.join(", ") || "None")}</p>
          <button onclick="updateProgress('${id}', '${c.id}')" class="text-blue-600 hover:underline text-sm" aria-label="Update progress for ${sanitizeInput(l.fullName || l.email)} in ${sanitizeInput(c.name)}" data-tooltip="Update progress">Update</button>
        </div>
      `;
    });
    progressItem.innerHTML = `
      <div>
        <p class="font-semibold">${sanitizeInput(l.fullName || l.email)}</p>
        <p class="text-sm text-gray-600">Email: ${sanitizeInput(l.email)}</p>
        ${progressHTML}
      </div>
    `;
    progressList.appendChild(progressItem);
  }
}

// Search progress
const searchProgress = debounce(filter => renderProgress(sanitizeInput(filter)), 300);
progressSearch.addEventListener("input", () => searchProgress(progressSearch.value));

// Update progress
window.updateProgress = async (learnerId, courseId) => {
  const l = learners[learnerId];
  const c = courses[courseId];
  const currentProgress = l.progress?.[courseId] || { completed: 0, total: 100, milestones: [] };
  const completed = prompt("Enter completed percentage (0-100):", currentProgress.completed);
  const milestones = prompt("Enter milestones (comma-separated, optional):", currentProgress.milestones.join(", "));
  if (completed && !isNaN(completed) && completed >= 0 && completed <= 100) {
    showSpinner();
    try {
      const updates = {};
      updates[`users/${learnerId}/progress/${courseId}`] = {
        completed: parseInt(completed),
        total: 100,
        milestones: milestones ? milestones.split(",").map(m => sanitizeInput(m.trim())).filter(m => m) : []
      };
      await update(ref(db, "/"), updates);
      if (completed == 100 && !c.completions?.includes(learnerId)) {
        await runTransaction(ref(db, `courses/${courseId}`), course => {
          course = course || { completions: [] };
          course.completions = course.completions || [];
          if (!course.completions.includes(learnerId)) course.completions.push(learnerId);
          return course;
        });
        if (confirm("Issue certificate for course completion?")) {
          await push(ref(db, "certifications"), {
            learnerId,
            courseId,
            issuedAt: Date.now(),
            providerId: auth.currentUser.uid
          });
          logAudit(`Issued certificate to ${l.fullName || l.email} for course ${c.name}`);
        }
      }
      logAudit(`Updated progress for ${l.fullName || l.email} in course ${c.name}`);
      alert("Progress updated successfully!");
    } catch (err) {
      console.error("Error updating progress:", err);
      alert("Failed to update progress.");
    }
    hideSpinner();
  } else {
    alert("Invalid progress value.");
  }
};

// Load analytics
function loadAnalytics() {
  showSpinner();
  onValue(ref(db, "courses"), snap => {
    courses = snap.val() || {};
    onValue(ref(db, "users"), snap => {
      learners = snap.val() || {};
      renderAnalytics();
      hideSpinner();
    });
  });
}

function renderAnalytics() {
  const time = timeRange.value;
  const courseId = courseFilter.value;
  const group = groupFilterAnalytics.value;

  const now = Date.now();
  const days = time === "all" ? Infinity : parseInt(time);
  const filteredCourses = Object.entries(courses).filter(([id, c]) => c.providerId === auth.currentUser.uid && !c.archived && (!courseId || id === courseId));

  const analyticsData = {
    labels: filteredCourses.map(([_, c]) => c.name),
    datasets: [
      {
        label: "Enrollments",
        data: filteredCourses.map(([_, c]) => c.enrolled?.length || 0),
        backgroundColor: "#2563eb",
        borderRadius: 4
      },
      {
        label: "Completions",
        data: filteredCourses.map(([_, c]) => c.completions?.length || 0),
        backgroundColor: "#10b981",
        borderRadius: 4
      }
    ]
  };

  if (analyticsChartInstance) analyticsChartInstance.destroy();
  analyticsChartInstance = new Chart(analyticsChart, {
    type: "bar",
    data: analyticsData,
    options: {
      scales: { y: { beginAtZero: true } },
      plugins: {
        datalabels: { anchor: "end", align: "top", color: "#374151", font: { weight: "bold" } }
      }
    },
    plugins: [ChartDataLabels]
  });

  const heatmapData = Array(24).fill(0).map(() => Array(7).fill(0));
  for (const id in learners) {
    const l = learners[id];
    if (l.role !== "learner" || l.providerId !== auth.currentUser.uid) continue;
    if (group && !l.metadata?.tags?.includes(group)) continue;
    notifications.filter(n => n.learnerId === id && (!courseId || n.courseId === courseId) && (time === "all" || now - n.timestamp <= days * 24 * 60 * 60 * 1000))
      .forEach(n => {
        const date = new Date(n.timestamp);
        const hour = date.getHours();
        const day = date.getDay();
        heatmapData[hour][day]++;
      });
  }

  if (heatmapChartInstance) heatmapChartInstance.destroy();
  heatmapChartInstance = new Chart(heatmapChart, {
    type: "matrix",
    data: {
      datasets: [{
        label: "Activity Heatmap",
        data: heatmapData.flatMap((row, h) => row.map((val, d) => ({ x: d, y: h, v: val }))),
        backgroundColor: c => {
          const value = c.raw.v;
          const alpha = Math.min(value / 10, 1);
          return `rgba(37, 99, 235, ${alpha})`;
        },
        width: ({ chart }) => chart.chartArea.width / 7,
        height: ({ chart }) => chart.chartArea.height / 24
      }]
    },
    options: {
      scales: {
        x: { type: "category", labels: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"] },
        y: { type: "category", labels: Array(24).fill(0).map((_, i) => `${i}:00`) }
      },
      plugins: { tooltip: { callbacks: { label: ctx => `Activity: ${ctx.raw.v}` } } }
    }
  });

  let totalEnrollments = 0, totalCompletions = 0, totalActivity = 0;
  filteredCourses.forEach(([_, c]) => {
    totalEnrollments += c.enrolled?.length || 0;
    totalCompletions += c.completions?.length || 0;
  });
  notifications.forEach(n => {
    if (time === "all" || now - n.timestamp <= days * 24 * 60 * 60 * 1000) {
      if ((!courseId || n.courseId === courseId) && learners[n.learnerId]?.providerId === auth.currentUser.uid && (!group || learners[n.learnerId]?.metadata?.tags?.includes(group))) {
        totalActivity++;
      }
    }
  });

  analyticsDetails.innerHTML = `
    <p>Total Enrollments: ${totalEnrollments}</p>
    <p>Total Completions: ${totalCompletions}</p>
    <p>Completion Rate: ${totalEnrollments > 0 ? (totalCompletions / totalEnrollments * 100).toFixed(1) : 0}%</p>
    <p>Total Activity Events: ${totalActivity}</p>
  `;
}

// Export analytics to PDF
exportAnalytics.addEventListener("click", () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text("CETA Provider Analytics", 20, 20);
  doc.setFontSize(12);
  doc.text(`Time Range: ${timeRange.options[timeRange.selectedIndex].text}`, 20, 30);
  doc.text(`Course: ${courseFilter.value ? courses[courseFilter.value]?.name : "All"}`, 20, 40);
  doc.text(`Group: ${groupFilterAnalytics.value || "All"}`, 20, 50);
  doc.text(analyticsDetails.textContent, 20, 60);
  doc.save("analytics_report.pdf");
});

// Load helpdesk tickets
function loadHelpdesk() {
  showSpinner();
  onValue(ref(db, "tickets"), snap => {
    tickets = snap.val() || {};
    renderTickets();
    hideSpinner();
  });
}

function renderTickets() {
  ticketList.innerHTML = "";
  for (const id in tickets) {
    const t = tickets[id];
    if (t.providerId !== auth.currentUser.uid) continue;
    const ticketItem = document.createElement("div");
    ticketItem.className = "bg-gray-50 p-4 rounded shadow hover:shadow-md transition-shadow";
    ticketItem.innerHTML = `
      <div class="flex justify-between items-center">
        <div>
          <p class="font-semibold">${sanitizeInput(t.title)}</p>
          <p class="text-sm text-gray-600">Learner: ${sanitizeInput(learners[t.learnerId]?.fullName || "Unknown")} | Status: ${sanitizeInput(t.status)}</p>
          <p class="text-sm text-gray-600">${sanitizeInput(t.description)}</p>
        </div>
        <div class="flex gap-2">
          <button onclick="resolveTicket('${id}')" class="text-blue-600 hover:underline" aria-label="Resolve ticket ${sanitizeInput(t.title)}" data-tooltip="Resolve ticket">Resolve</button>
          <button onclick="deleteTicket('${id}')" class="text-red-600 hover:underline" aria-label="Delete ticket ${sanitizeInput(t.title)}" data-tooltip="Delete ticket">Delete</button>
        </div>
      </div>
    `;
    ticketList.appendChild(ticketItem);
  }
}

// Resolve ticket
window.resolveTicket = async ticketId => {
  const resolution = prompt("Enter resolution notes:");
  if (resolution) {
    showSpinner();
    try {
      await update(ref(db, `tickets/${ticketId}`), {
        status: "resolved",
        resolution: sanitizeInput(resolution),
        resolvedAt: Date.now()
      });
      logAudit(`Resolved ticket ${tickets[ticketId].title}`);
      alert("Ticket resolved successfully!");
    } catch (err) {
      console.error("Error resolving ticket:", err);
      alert("Failed to resolve ticket.");
    }
    hideSpinner();
  }
};

// Delete ticket
window.deleteTicket = async ticketId => {
  if (!confirm("Are you sure you want to delete this ticket?")) return;
  showSpinner();
  try {
    await remove(ref(db, `tickets/${ticketId}`));
    logAudit(`Deleted ticket ${tickets[ticketId].title}`);
    alert("Ticket deleted successfully!");
  } catch (err) {
    console.error("Error deleting ticket:", err);
    alert("Failed to delete ticket.");
  }
  hideSpinner();
};

// Load video feeds
function loadVideoFeeds() {
  showSpinner();
  onValue(ref(db, "courses"), snap => {
    courses = snap.val() || {};
    renderVideoFeeds();
    hideSpinner();
  });
}

function renderVideoFeeds(filter = "", courseFilter = "") {
  videoFeedList.innerHTML = "";
  const peer = new Peer();
  peer.on("open", id => {
    for (const id in learners) {
      const l = learners[id];
      if (l.role !== "learner" || l.providerId !== auth.currentUser.uid) continue;
      if (filter && !l.fullName?.toLowerCase().includes(filter.toLowerCase()) && !l.email.toLowerCase().includes(filter.toLowerCase())) continue;
      const enrolledCourses = Object.keys(courses).filter(cId => courses[cId].enrolled?.includes(id) && (!courseFilter || cId === courseFilter));
      if (enrolledCourses.length === 0) continue;
      const videoItem = document.createElement("div");
      videoItem.className = "video-feed relative";
      videoItem.innerHTML = `
        <div class="video-label">${sanitizeInput(l.fullName || l.email)}</div>
        <video id="video-${id}" autoplay muted playsinline class="w-full h-48 object-cover"></video>
      `;
      videoFeedList.appendChild(videoItem);
      // Simulate video feed connection (placeholder for actual WebRTC implementation)
      console.log(`Connecting to video feed for learner ${l.email} with peer ID ${id}`);
    }
  });
}

// Search video feeds
const searchVideoFeeds = debounce((filter, course) => renderVideoFeeds(sanitizeInput(filter), course), 300);
videoSearch.addEventListener("input", () => searchVideoFeeds(videoSearch.value, videoCourseFilter.value));
videoCourseFilter.addEventListener("change", () => searchVideoFeeds(videoSearch.value, videoCourseFilter.value));

// Download certificate
window.downloadCertificate = async certId => {
  const cert = certifications[certId];
  const learner = learners[cert.learnerId];
  const course = courses[cert.courseId];
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(20);
  doc.text("Certificate of Completion", 20, 20);
  doc.setFontSize(14);
  doc.text(`Awarded to: ${sanitizeInput(learner.fullName || learner.email)}`, 20, 40);
  doc.text(`Course: ${sanitizeInput(course.name)}`, 20, 50);
  doc.text(`Issued on: ${new Date(cert.issuedAt).toLocaleDateString()}`, 20, 60);
  doc.save(`certificate_${learner.email}_${course.name}.pdf`);
};

// Audit logging
function logAudit(message) {
  push(ref(db, `auditLogs/${auth.currentUser.uid}`), {
    message: sanitizeInput(message),
    timestamp: Date.now(),
    userId: auth.currentUser.uid
  });
}

// Populate course filter
function populateCourseFilter() {
  courseFilter.innerHTML = '<option value="">All Courses</option>';
  videoCourseFilter.innerHTML = '<option value="">All Courses</option>';
  for (const id in courses) {
    if (courses[id].providerId === auth.currentUser.uid && !courses[id].archived) {
      const option = document.createElement("option");
      option.value = id;
      option.textContent = sanitizeInput(courses[id].name);
      courseFilter.appendChild(option);
      videoCourseFilter.appendChild(option.cloneNode(true));
    }
  }
}

// Initialize
onAuthStateChanged(auth, u => {
  if (u) {
    user = u;
    loadOverview();
    loadLearners();
    loadCourses();
    loadContent();
    loadAssignments();
    loadForums();
    loadQuizzes();
    loadProgress();
    loadAnalytics();
    loadHelpdesk();
    loadVideoFeeds();
    onValue(ref(db, "notifications"), snap => {
      notifications = Object.values(snap.val() || {}).filter(n => courses[n.courseId]?.providerId === u.uid);
    });
  } else {
    window.location.href = "login.html";
  }
});

// Sign out
document.getElementById("signout-btn").addEventListener("click", async () => {
  try {
    await signOut(auth);
    window.location.href = "login.html";
  } catch (err) {
    console.error("Sign out error:", err);
    alert("Failed to sign out.");
  }
});
  </script>
</body>
</html>
